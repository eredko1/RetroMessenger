<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OSWeb v1 Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default Dark Theme Variables (Fallback if no theme class is applied) */
            --accent-color: #82AAFF; 
            --secondary-accent: #C3E88D; 
            --error-color: #FF5370;
            --warning-color: #FFCB6B; 
            
            --primary-bg: #1E1E1E; 
            --primary-bg-rgb: 30, 30, 30;
            --surface-bg: #2A2A2A; 
            --surface-bg-rgb: 42, 42, 42; 
            --surface-overlay-bg: rgba(255, 255, 255, 0.05); 
            --surface-active-bg: rgba(255, 255, 255, 0.08);

            --text-primary: #E0E0E0; 
            --text-secondary: #B0B0B0; 
            --border-color: rgba(255, 255, 255, 0.12);
            --icon-color: #B0B0B0;
            --disabled-opacity: 0.5;

            --dock-bg-opacity: 0.5; /* Defaulted to High */
            --window-content-bg: var(--surface-bg); 
        }
        body {
            font-family: 'Roboto', 'Google Sans', sans-serif;
            background-color: var(--primary-bg);
            color: var(--text-primary);
            overflow: hidden;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        body.light-mode {
            --primary-bg: #F4F6F8; 
            --primary-bg-rgb: 244, 246, 248;
            --surface-bg: #FFFFFF; 
            --surface-bg-rgb: 255, 255, 255;
            --surface-overlay-bg: rgba(0, 0, 0, 0.04); 
            --surface-active-bg: rgba(0, 0, 0, 0.08);
            --text-primary: #212121; 
            --text-secondary: #5F6368; 
            --border-color: rgba(0, 0, 0, 0.12);
            --icon-color: #5F6368;
            --warning-color: #FFA000; 
            --accent-color: #1976D2; 
            --secondary-accent: #4CAF50;
        }
        
        body.indigo-magic-theme {
            --primary-bg: #2E3440; 
            --primary-bg-rgb: 46, 52, 64;
            --surface-bg: #3B4252; 
            --surface-bg-rgb: 59, 66, 82;
            --surface-overlay-bg: rgba(216, 222, 233, 0.07); 
            --surface-active-bg: rgba(216, 222, 233, 0.12);
            --accent-color: #88C0D0; 
            --secondary-accent: #A3BE8C; 
            --error-color: #BF616A; 
            --warning-color: #EBCB8B; 
            --text-primary: #ECEFF4; 
            --text-secondary: #D8DEE9; 
            --border-color: #4C566A; 
            --icon-color: #D8DEE9;
        }
        body.indigo-magic-theme #top-panel, 
        body.indigo-magic-theme #dock {
            background-color: rgba(var(--surface-bg-rgb), var(--dock-bg-opacity, 0.85)) !important;
            border-bottom-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3), 0 1px 2px rgba(0,0,0,0.24);
        }
        body.indigo-magic-theme .window-title-bar {
            background-color: #434C5E; 
            border-bottom: 1px solid #2E3440; 
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.05), rgba(0,0,0,0.05));
        }
        body.indigo-magic-theme .window.focused { box-shadow: 0 0 0 1.5px var(--accent-color), 0 8px 20px rgba(0,0,0,0.25); }
        body.indigo-magic-theme .vdesktop-button.active { background-color: var(--accent-color); color: #2E3440; }
        body.indigo-magic-theme .action-button { background-color: var(--accent-color); color: #2E3440; border: 1px solid color-mix(in srgb, var(--accent-color) 80%, black); }
        body.indigo-magic-theme .action-button:hover { background-color: color-mix(in srgb, var(--accent-color) 90%, #ECEFF4); }
        body.indigo-magic-theme .desktop-icon i { color: var(--accent-color); }
        body.indigo-magic-theme .desktop-icon:hover { background-color: rgba(var(--surface-bg-rgb), 0.5); }
        body.indigo-magic-theme #custom-modal-cancel { background-color: #4C566A !important; }
        body.indigo-magic-theme #custom-modal-cancel:hover { background-color: #5E81AC !important; }
        body.indigo-magic-theme #wallpaper-container { background: #2E3440; }

        body.crimson-peak-theme {
            --primary-bg: #2C2C2C; 
            --primary-bg-rgb: 44, 44, 44;
            --surface-bg: #3C3C3C; 
            --surface-bg-rgb: 60, 60, 60;
            --surface-overlay-bg: rgba(245, 245, 245, 0.06); 
            --surface-active-bg: rgba(245, 245, 245, 0.1);
            --accent-color: #E53935; /* Crimson Red */
            --secondary-accent: #FDD835; /* Amber/Gold */
            --error-color: #FF5370; 
            --warning-color: #FFCB6B; 
            --text-primary: #F5F5F5; 
            --text-secondary: #BDBDBD; 
            --border-color: #202020; 
            --icon-color: #D0D0D0;
        }
        body.crimson-peak-theme #top-panel, 
        body.crimson-peak-theme #dock {
            background-color: rgba(var(--surface-bg-rgb), var(--dock-bg-opacity, 0.85)) !important;
            border-bottom-color: var(--border-color) !important;
            box-shadow: 0 1px 3px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.3);
        }
        body.crimson-peak-theme .window-title-bar {
            background-color: #4A2A2A; 
            border-bottom: 1px solid var(--primary-bg); 
            background-image: linear-gradient(to bottom, rgba(255,255,255,0.04), rgba(0,0,0,0.04));
        }
        body.crimson-peak-theme .window.focused { box-shadow: 0 0 0 1.5px var(--accent-color), 0 8px 20px rgba(0,0,0,0.3); }
        body.crimson-peak-theme .vdesktop-button.active { background-color: var(--accent-color); color: var(--text-primary); }
        body.crimson-peak-theme .action-button { background-color: var(--accent-color); color: var(--text-primary); border: 1px solid color-mix(in srgb, var(--accent-color) 70%, black); }
        body.crimson-peak-theme .action-button:hover { background-color: color-mix(in srgb, var(--accent-color) 90%, white); }
        body.crimson-peak-theme .desktop-icon i { color: var(--accent-color); }
        body.crimson-peak-theme .desktop-icon:hover { background-color: rgba(var(--surface-bg-rgb), 0.6); }
        body.crimson-peak-theme #custom-modal-cancel { background-color: #555 !important; }
        body.crimson-peak-theme #custom-modal-cancel:hover { background-color: #666 !important; }
        body.crimson-peak-theme #wallpaper-container { background: #2C2C2C; }
        body.crimson-peak-theme .terminal-output span.prompt { color: var(--secondary-accent); } 
        body.crimson-peak-theme .terminal-output span.explanation { color: var(--accent-color); }


        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: rgba(0,0,0,0.1); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: rgba(var(--icon-color-rgb, 176, 176, 176), 0.5); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(var(--icon-color-rgb, 176, 176, 176), 0.7); }
        body.light-mode ::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); }
        body.light-mode ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); }
        body.light-mode ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
        body.indigo-magic-theme ::-webkit-scrollbar-thumb { background: #4C566A; }
        body.indigo-magic-theme ::-webkit-scrollbar-thumb:hover { background: #5E81AC; }
        body.crimson-peak-theme ::-webkit-scrollbar-thumb { background: #5C5C5C; }
        body.crimson-peak-theme ::-webkit-scrollbar-thumb:hover { background: var(--secondary-accent); }


        .surface-card { 
            background: var(--surface-bg);
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 5px 0 rgba(0,0,0,0.2), 0 4px 12px 0 rgba(0,0,0,0.15);
            transition: background-color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
        }
        body.light-mode .surface-card {
            box-shadow: 0 2px 5px 0 rgba(0,0,0,0.08), 0 4px 12px 0 rgba(0,0,0,0.06);
        }
        
        #dock {
            background-color: rgba(var(--surface-bg-rgb), var(--dock-bg-opacity)); 
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            transition: background-color 0.3s ease; 
        }

        .window-content-area {
            background-color: var(--window-content-bg); 
            transition: background-color 0.3s ease;
        }
        .window.glass-mode .window-content-area {
            background-color: rgba(var(--surface-bg-rgb), 0.01) !important; /* Ensure high transparency for glass */
            backdrop-filter: blur(8px); 
            -webkit-backdrop-filter: blur(8px);
        }
        /* Ensure content inside glass windows doesn't have opaque backgrounds unless intended */
        .window.glass-mode .window-content-area > *:not(.terminal-output):not(.code-editor-content):not(.notepad-content):not(.calculator-grid):not(.calc-display):not(.mail-grid):not(.music-player-content):not(.app-launcher-grid) {
             /* This is a general rule, specific app content might need more granular control */
        }


        .window-title-bar {
            cursor: grab; user-select: none;
            background-color: rgba(0,0,0,0.1); 
            padding: 0.5rem 0.75rem; height: 2.75rem; 
            border-bottom: 1px solid var(--border-color);
            display: flex; align-items: center; justify-content: space-between;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.light-mode .window-title-bar {
            background-color: rgba(0,0,0,0.03);
        }
        .window-title-bar:active { cursor: grabbing; }
        .window-title-bar .app-icon { color: var(--accent-color); margin-right: 0.625rem;}
        .window-title-bar .app-name { font-weight: 500; font-size: 0.9rem; color: var(--text-primary); }


        .top-panel-item, .dock-icon, .sidebar-icon, .window-control, .vdesktop-button, .notepad-action-button, .action-button, #theme-toggle-button, .menubar-item, .system-meter {
            transition: background-color 0.18s cubic-bezier(0.4, 0, 0.2, 1), color 0.18s cubic-bezier(0.4, 0, 0.2, 1), transform 0.15s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.18s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 0.375rem; 
            color: var(--icon-color);
            padding: 0.375rem 0.625rem; 
        }
        .menubar-item {
            font-size: 0.875rem; 
            font-weight: 500; 
            color: var(--text-primary);
        }
        .menubar-item.app-title { 
            font-weight: 700; 
            color: var(--text-primary); 
            padding-right: 0.75rem; 
        }
        .system-meter {
            font-size: 0.75rem; /* text-xs */
            padding: 0.25rem 0.5rem;
            color: var(--text-secondary);
        }


        .top-panel-item:hover, .dock-icon:hover, .sidebar-icon:hover, .window-control:hover, .vdesktop-button:not(.remove-desktop-btn):hover, .notepad-action-button:hover, .action-button:hover, #theme-toggle-button:hover, .menubar-item:hover {
            background-color: var(--surface-overlay-bg);
            color: var(--accent-color);
            transform: translateY(-1px); 
        }
        .remove-desktop-btn:hover {
            color: var(--error-color);
            transform: scale(1.1);
        }
        .top-panel-item:active, .dock-icon:active, .sidebar-icon:active, .window-control:active, .vdesktop-button:active, .notepad-action-button:active, .action-button:active, #theme-toggle-button:active, .menubar-item:active {
            background-color: var(--surface-active-bg);
            transform: scale(0.96); 
        }
        
        #app-menu-bar-container { 
            display: flex;
            align-items: center;
            height: 100%;
        }

        .action-button { 
            background-color: var(--accent-color);
            color: var(--primary-bg); 
            font-weight: 500;
            padding: 0.375rem 0.75rem;
            border: 1px solid transparent; 
        }
         body.light-mode .action-button {
            color: #FFFFFF; 
        }
        .action-button:hover {
            background-color: color-mix(in srgb, var(--accent-color) 90%, white);
        }
        body.light-mode .action-button:hover {
            background-color: color-mix(in srgb, var(--accent-color) 90%, black 5%);
        }


        .dock-icon.active {
             background-color: var(--surface-active-bg);
             border-bottom: 3px solid var(--accent-color);
             box-shadow: 0 0 10px color-mix(in srgb, var(--accent-color) 50%, transparent);
        }
        .vdesktop-button.active {
            background-color: var(--accent-color);
            color: var(--primary-bg) !important; 
            font-weight: bold;
        }
        body.light-mode .vdesktop-button.active {
            color: #FFFFFF !important; 
        }
        .vdesktop-button-container {
            position: relative;
            display: flex;
            align-items: center;
        }
        .remove-desktop-btn {
            position: absolute;
            top: -6px; /* Adjust for visual centering */
            right: -3px; /* Adjust for visual centering */
            font-size: 0.6rem; /* Smaller icon */
            padding: 0.1rem;
            line-height: 1;
            color: var(--icon-color);
            opacity: 0.5;
            transition: opacity 0.2s, color 0.2s, transform 0.2s;
        }
        .vdesktop-button-container:hover .remove-desktop-btn {
            opacity: 1;
        }


        #wallpaper-container {
            position: absolute; top: 0; left: 0; right: 0; bottom: 0; z-index: -1;
            background: linear-gradient(145deg, #0D0D0D 0%, #1A1A1A 50%, #2C2C2C 100%); 
            transition: background 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            background-size: cover;
            background-position: center center;
        }
        body.light-mode #wallpaper-container {
            background: linear-gradient(145deg, #E8EAF6 0%, #C5CAE9 70%, #9FA8DA 100%); 
        }


        .context-menu {
            display: none; position: absolute; z-index: 10000;
            min-width: 220px; padding: 0.5rem 0; 
            border-radius: 0.5rem; 
        }
        .context-menu-item {
            display: flex; align-items: center;
            padding: 0.75rem 1.25rem; 
            font-size: 0.875rem; 
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
            color: var(--text-primary);
        }
        .context-menu-item:hover { background-color: var(--surface-overlay-bg); }
        .context-menu-item i { margin-right: 1rem; width: 1.25em; color: var(--icon-color); }
        .context-menu-divider { height: 1px; background-color: var(--border-color); margin: 0.5rem 0; }
        .context-menu-item.has-submenu::after { /* Basic arrow for submenu */
            content: '▶';
            font-size: 0.7em;
            position: absolute;
            right: 1rem;
            color: var(--icon-color);
        }

        .notification { animation: fadeInSlideDown 0.4s cubic-bezier(0.4, 0, 0.2, 1) forwards; }
        @keyframes fadeInSlideDown { from { opacity: 0; transform: translateY(-10px) scale(0.98); } to { opacity: 1; transform: translateY(0) scale(1); } }
        
        .temp-message {
            position: fixed; bottom: 70px; left: 50%;
            transform: translateX(-50%);
            background-color: #333842; 
            color: #E8EAED; padding: 14px 24px; border-radius: 0.375rem; 
            z-index: 20000; font-size: 0.9rem; 
            box-shadow: 0 3px 6px rgba(0,0,0,0.3);
            opacity: 0; transition: opacity 0.3s ease-out, transform 0.3s ease-out, bottom 0.3s ease-out, background-color 0.3s ease, color 0.3s ease; pointer-events: none;
        }
        body.light-mode .temp-message {
            background-color: #FFFFFF;
            color: #212121;
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }
        .temp-message.show { opacity: 1; transform: translateX(-50%) translateY(0px); bottom: 80px; }

        .window {
            min-width: 320px; min-height: 240px; 
            transition: opacity 0.28s cubic-bezier(0.4, 0, 0.2, 1), transform 0.28s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.28s cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, opacity;
            border-radius: 0.625rem; 
        }
        .window.hidden-on-desktop { display: none !important; }
        .window.opening { opacity: 0; transform: scale(0.92) translateY(15px); }
        .window.closing { opacity: 0 !important; transform: scale(0.92) translateY(15px) !important; }
        .window.minimized { display: none !important; }
        .window.maximized {
            top: 0 !important; left: 0 !important; width: 100% !important; height: 100% !important;
            border-radius: 0 !important; min-width: unset; min-height: unset;
        }
        .window.maximized .window-title-bar { border-top-left-radius: 0; border-top-right-radius: 0; }
        .window.focused {
             box-shadow: 0 0 0 2px var(--accent-color), 0 8px 24px rgba(0,0,0,0.3);
        }
        body.light-mode .window.focused {
            box-shadow: 0 0 0 2px var(--accent-color), 0 8px 24px rgba(0,0,0,0.15);
        }


        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 22px; height: 22px; cursor: se-resize; z-index: 10;
            touch-action: none;
        }
        .resize-handle::after {
            content: ''; position: absolute; bottom: 5px; right: 5px; width: 8px; height: 8px;
            border-bottom: 2.5px solid var(--icon-color);
            border-right: 2.5px solid var(--icon-color);
            opacity: 0.7;
            transform: rotate(45deg) translateX(-2px) translateY(-2px);
            transition: all 0.2s ease;
        }
        .resize-handle:hover::after { opacity: 1; border-color: var(--accent-color); }
        .window.maximized .resize-handle { display: none; }

        .terminal-content textarea, .terminal-output {
            font-family: 'Roboto Mono', 'Courier New', Courier, monospace !important; 
            background-color: transparent !important; 
            color: var(--text-primary) !important; 
            line-height: 1.5;
             transition: color 0.3s ease; 
        }
        .terminal-output span.prompt { color: var(--secondary-accent); } 
        body.light-mode .terminal-output span.prompt { color: #007BFF; } 
        .terminal-output span.command { color: var(--text-primary); }
        .terminal-output span.response { color: var(--text-secondary); }
        .terminal-output span.error { color: var(--error-color); }
        body.light-mode .terminal-output span.error { color: #D32F2F; }
        .terminal-output span.explanation { color: var(--accent-color); font-style: italic; } 
        body.light-mode .terminal-output span.explanation { color: #1976D2; }
        .terminal-output .neofetch-art { white-space: pre; font-family: 'Roboto Mono', monospace; line-height: 1.1; color: var(--accent-color); }
        .terminal-output .neofetch-label { color: var(--secondary-accent); }
        .terminal-output .tree-item { margin-left: 1.5em; position: relative; }
        .terminal-output .tree-item::before { content: "├── "; position: absolute; left: -1.5em; color: var(--text-secondary); }
        .terminal-output .tree-item.last::before { content: "└── "; }


        .code-editor-content textarea, .notepad-content textarea {
            font-family: 'Roboto Mono', 'Courier New', Courier, monospace !important;
            background-color: transparent !important; 
            color: var(--text-primary) !important;
            line-height: 1.6;
            border: none !important;
            transition: color 0.3s ease; 
        }
        .notepad-toolbar {
            padding: 0.5rem;
            border-top: 1px solid var(--border-color);
            background-color: rgba(0,0,0,0.1); 
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        body.light-mode .notepad-toolbar {
            background-color: rgba(0,0,0,0.03);
        }

        .notepad-action-button { 
            border: 1px solid var(--border-color);
            background-color: var(--surface-overlay-bg);
            color: var(--text-secondary);
            padding: 0.375rem 0.75rem;
        }
        .notepad-action-button:hover {
            border-color: var(--accent-color);
        }
        .notepad-action-button:disabled, 
        body.light-mode .notepad-action-button:disabled { 
             opacity: var(--disabled-opacity); cursor: not-allowed; 
             background-color: var(--surface-overlay-bg); 
             color: var(--text-secondary); 
             border-color: var(--border-color);
        }
        
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .calc-button {
            background-color: var(--surface-overlay-bg); border-radius: 0.5rem;
            padding: 1rem 0; text-align: center; font-size: 1.1rem;
            cursor: pointer; transition: all 0.1s ease; color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        .calc-button:active { transform: scale(0.96); background-color: var(--surface-active-bg); }
        .calc-button:hover { background-color: color-mix(in srgb, var(--surface-overlay-bg) 80%, white); }
        body.light-mode .calc-button:hover { background-color: color-mix(in srgb, var(--surface-overlay-bg) 80%, black 5%); }
        
        .calc-button.operator { background-color: color-mix(in srgb, var(--surface-bg) 80%, var(--accent-color) 20%); }
        .calc-button.operator:hover { background-color: color-mix(in srgb, var(--surface-bg) 70%, var(--accent-color) 30%); }
        body.light-mode .calc-button.operator { background-color: color-mix(in srgb, var(--surface-bg) 90%, var(--accent-color) 25%); }
        body.light-mode .calc-button.operator:hover { background-color: color-mix(in srgb, var(--surface-bg) 80%, var(--accent-color) 35%); }

        .calc-button.equals { background-color: var(--accent-color); color: var(--primary-bg); font-weight: 500; }
        body.light-mode .calc-button.equals { color: #FFFFFF; }
        .calc-button.equals:hover { background-color: color-mix(in srgb, var(--accent-color) 90%, white); }
        body.light-mode .calc-button.equals:hover { background-color: color-mix(in srgb, var(--accent-color) 90%, black 5%); }
        
        .calc-display {
            background-color: var(--primary-bg); border-radius: 0.5rem;
            padding: 0.75rem 1rem; text-align: right; font-size: 2.5rem; margin-bottom: 1rem;
            color: var(--text-primary); min-height: 70px; word-wrap: break-word;
            overflow-x: auto; border: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }

        .loading-spinner {
            display: inline-block; width: 1em; height: 1em;
            border: 2px solid currentColor; border-right-color: transparent;
            border-radius: 50%; animation: spinner-border .75s linear infinite;
            vertical-align: text-bottom; margin-left: 0.5em;
        }
        @keyframes spinner-border { to { transform: rotate(360deg); } }

        .mail-grid { display: grid; grid-template-columns: 200px 1fr; height: 100%; } 
        .mail-sidebar { border-right: 1px solid var(--border-color); padding: 0.5rem; overflow-y: auto; transition: border-color 0.3s ease; background-color: transparent; }
        .mail-sidebar-item { padding: 0.5rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.875rem; }
        .mail-sidebar-item:hover { background-color: var(--surface-overlay-bg); }
        .mail-sidebar-item.active { background-color: var(--accent-color); color: var(--primary-bg); font-weight: 500; }
        body.light-mode .mail-sidebar-item.active { color: #FFFFFF; }
        .mail-content { padding: 0.5rem; overflow-y: auto; display: flex; flex-direction: column; background-color: transparent;}
        .mail-message-list-item { padding: 0.75rem 0.5rem; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 0.875rem; transition: border-color 0.3s ease; }
        .mail-message-list-item:hover { background-color: var(--surface-overlay-bg); }
        .mail-message-preview { margin-top: 0.5rem; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.375rem; flex-grow: 1; background-color: rgba(0,0,0,0.05); transition: background-color 0.3s ease, border-color 0.3s ease;}
        body.light-mode .mail-message-preview { background-color: rgba(0,0,0,0.03); }

        .music-player-content { display: flex; flex-direction: column; height: 100%; padding: 1rem; background-color: transparent; }
        .music-track-info { text-align: center; margin-bottom: 1.5rem; }
        .music-track-info img { width: 128px; height: 128px; object-fit: cover; margin: 0 auto 0.75rem; border-radius: 0.5rem; background-color: var(--surface-overlay-bg); }
        .music-controls { display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.5rem; }
        .music-playlist { flex-grow: 1; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 0.375rem; padding: 0.5rem; background-color: rgba(0,0,0,0.05); transition: background-color 0.3s ease, border-color 0.3s ease;}
        body.light-mode .music-playlist { background-color: rgba(0,0,0,0.03); }
        .music-playlist-item { padding: 0.5rem; border-bottom: 1px solid var(--border-color); cursor: pointer; font-size: 0.875rem; transition: border-color 0.3s ease;}
        .music-playlist-item:hover { background-color: var(--surface-overlay-bg); }
        
        /* Desktop Icon (App Launcher Folder) */
        .desktop-icon {
            position: absolute;
            width: 80px;
            height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            cursor: grab;
            user-select: none;
            padding: 0.5rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .desktop-icon:hover {
            background-color: var(--surface-overlay-bg);
        }
        .desktop-icon i {
            font-size: 2.5rem; /* Increased icon size */
            color: var(--accent-color);
            margin-bottom: 0.25rem;
        }
        .desktop-icon span {
            font-size: 0.75rem; /* text-xs */
            color: var(--text-primary);
            word-break: break-word;
        }
        .app-launcher-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 1rem;
            padding: 1rem;
            overflow-y: auto;
            max-height: 400px; /* Or adjust as needed */
        }
        .app-launcher-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            text-align: center;
            background-color: var(--surface-overlay-bg);
            transition: background-color 0.2s ease;
        }
        .app-launcher-item:hover {
            background-color: var(--surface-active-bg);
            color: var(--accent-color);
        }
        .app-launcher-item i {
            font-size: 1.75rem; /* text-2xl */
            margin-bottom: 0.5rem;
            color: var(--accent-color);
        }
        .app-launcher-item span {
            font-size: 0.75rem; /* text-xs */
            color: var(--text-primary);
        }
        #right-sidebar .sidebar-section { margin-bottom: 1.5rem; }
        #right-sidebar .sidebar-section h2 { font-size: 1.125rem; font-weight: 500; margin-bottom: 0.75rem; color: var(--text-primary); }
        #right-sidebar .sidebar-list-item {
            font-size: 0.875rem; color: var(--text-secondary); padding: 0.5rem;
            border-radius: 0.375rem; transition: background-color 0.15s ease; cursor: pointer;
        }
        #right-sidebar .sidebar-list-item:hover { background-color: var(--surface-overlay-bg); color: var(--accent-color); }
        #right-sidebar .sidebar-list-item i { margin-right: 0.5rem; color: var(--icon-color); }
        #right-sidebar .sidebar-list-item:hover i { color: var(--accent-color); }

        /* Login Modal */
        #login-modal {
            position: fixed; inset: 0; z-index: 20000;
            display: flex; align-items: center; justify-content: center;
            background-color: rgba(0,0,0,0.7);
            backdrop-filter: blur(5px);
        }
        #login-modal.hidden { display: none; }
        #login-modal > div {
            background-color: var(--surface-bg);
            padding: 2rem; border-radius: 0.75rem; box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            width: 100%; max-width: 360px; text-align: center;
        }
        #login-modal h2 { font-size: 1.5rem; color: var(--text-primary); margin-bottom: 1rem; }
        #login-modal input {
            width: 100%; padding: 0.75rem; margin-bottom: 1rem;
            border-radius: 0.375rem; border: 1px solid var(--border-color);
            background-color: var(--primary-bg); color: var(--text-primary);
            outline-color: var(--accent-color);
        }
        /* Settings App Specific Styles */
        .settings-grid { display: grid; grid-template-columns: 200px 1fr; height: 100%; }
        .settings-sidebar { border-right: 1px solid var(--border-color); padding: 0.5rem; overflow-y: auto; }
        .settings-sidebar-item { padding: 0.75rem; border-radius: 0.375rem; cursor: pointer; font-size: 0.9rem; }
        .settings-sidebar-item:hover { background-color: var(--surface-overlay-bg); }
        .settings-sidebar-item.active { background-color: var(--accent-color); color: var(--primary-bg); font-weight: 500; }
        body.light-mode .settings-sidebar-item.active { color: #FFFFFF; }
        .settings-content-pane { padding: 1.5rem; overflow-y: auto; }
        .settings-section h3 { font-size: 1.25rem; font-weight: 500; margin-bottom: 1rem; color: var(--text-primary); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem;}
        .settings-item { margin-bottom: 1rem; }
        .settings-item label { display: block; font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 0.25rem; }
        .settings-item select, .settings-item input[type="text"], .settings-item input[type="range"] {
            width: 100%; padding: 0.5rem; border-radius: 0.375rem; border: 1px solid var(--border-color);
            background-color: var(--surface-overlay-bg); color: var(--text-primary);
        }


        /* Mobile UI Adjustments */
        body.mobile-ui #app-menu-bar-container { display: none !important; }
        body.mobile-ui #cpu-meter, body.mobile-ui #gpu-meter { display: none !important; }
        body.mobile-ui #global-search-input { width: 6rem; /* w-24 */ } /* Further reduce search bar on mobile */
        body.mobile-ui #dock { padding-left: 0.25rem; padding-right: 0.25rem; }
        body.mobile-ui #dock .dock-icon { padding: 0.5rem; font-size: 1rem; } /* Smaller dock icons */
        body.mobile-ui #right-sidebar { width: 80vw; } /* Sidebar takes more width */

    </style>
</head>
<body> 

    <div id="wallpaper-container"></div>

    <header id="top-panel" class="surface-card h-14 w-full px-3 sm:px-4 flex items-center justify-between z-50 flex-shrink-0 !shadow-md !border-0 !border-b !border-[var(--border-color)]">
        <div class="flex items-center space-x-1 sm:space-x-2">
            <!-- App Launcher Button Added -->
            <button id="app-launcher-button" class="top-panel-item p-2.5 rounded-full focus:outline-none" title="App Launcher"> <i class="fas fa-th-large text-lg"></i> </button>
            <button id="show-desktop-button" class="top-panel-item p-2.5 rounded-full focus:outline-none" title="Show Desktop"> <i class="fas fa-desktop text-lg"></i> </button>
            <button id="activities-button" class="top-panel-item p-2.5 rounded-full focus:outline-none" title="Overview"> <i class="fas fa-layer-group text-lg"></i> </button> <!-- Changed icon for Activities -->
            <div id="virtual-desktop-switcher" class="flex space-x-1.5 items-center">
                <!-- Desktop buttons will be populated by JavaScript -->
            </div>
            <button id="add-desktop-button" class="top-panel-item p-1.5 rounded-full focus:outline-none !ml-1" title="Add Virtual Desktop"> <i class="fas fa-plus text-xs"></i> </button>
            <div id="app-menu-bar-container" class="flex items-center h-full ml-1 sm:ml-2 hidden sm:flex">
                <!-- App-specific menu items will appear here -->
            </div>
        </div>
        <div class="flex items-center space-x-2 sm:space-x-3">
            <div id="cpu-meter" class="system-meter" title="CPU Usage">CPU: 0%</div>
            <div id="gpu-meter" class="system-meter" title="GPU Usage">GPU: 0%</div>
            <div id="clock" class="text-sm font-medium"></div>
        </div>
        <div class="flex items-center space-x-1 sm:space-x-2">
             <div class="relative">
                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-[var(--icon-color)] text-sm"></i>
                <input id="global-search-input" type="search" placeholder="Search Google..." class="bg-[var(--surface-overlay-bg)] border border-transparent text-sm rounded-full py-2 px-4 pl-10 w-24 sm:w-32 md:w-40 focus:w-32 sm:focus:w-40 md:focus:w-48 transition-all duration-300 outline-none placeholder-[var(--text-secondary)] focus:ring-1 focus:ring-[var(--accent-color)] focus:border-transparent focus:bg-[var(--surface-active-bg)]">
            </div>
            <button id="theme-toggle-button" class="top-panel-item p-2.5 rounded-full" title="Switch to Light Mode"><i class="fas fa-moon text-base"></i></button>
            <button class="top-panel-item p-2.5 rounded-full" title="Network" onclick="showTemporaryMessage('Network: Connected', 1500)"><i class="fas fa-wifi text-base"></i></button>
            <button id="sidebar-toggle" class="top-panel-item p-2.5 rounded-full focus:outline-none" title="Control Panel"> <i class="fas fa-sliders-h text-base"></i> </button>
             <button id="user-avatar-button" class="top-panel-item p-1.5 rounded-full" title="User Account"> <img src="https://placehold.co/32x32/82AAFF/1E1E1E?text=U&font=roboto" alt="User" class="rounded-full h-8 w-8" id="user-avatar-img"> </button>
        </div>
    </header>

    <main id="desktop-area" class="flex-grow p-1 sm:p-2 md:p-4 relative overflow-hidden flex items-center justify-center">
        <!-- Desktop icons like "My Files" can still exist here -->
        <div id="my-files-folder" class="desktop-icon" style="top: 50px; left: 50px;"> <!-- Adjusted position as App Launcher icon is removed from desktop -->
            <i class="fas fa-folder-open"></i>
            <span>My Files</span>
        </div>
    </main>

    <nav id="dock" class="surface-card w-max mx-auto mb-2 sm:mb-3 px-2 sm:px-3 py-1.5 sm:py-2 rounded-2xl flex items-center space-x-1 sm:space-x-1.5 md:space-x-2 z-50 flex-shrink-0 !shadow-lg">
        <!-- Dock icons will be populated by JavaScript -->
    </nav>

    <aside id="right-sidebar" class="surface-card fixed top-16 right-0 h-[calc(100vh-4rem-0.5rem)] sm:h-[calc(100vh-4rem-0.75rem)] w-72 sm:w-80 md:w-96 p-4 sm:p-5 space-y-3 transform transition-transform duration-300 ease-out z-40 !shadow-xl overflow-y-auto">
        <!-- Sidebar content remains the same, but will be open by default after login -->
        <div class="sidebar-section">
            <h2>Notifications</h2>
            <div id="notifications-container" class="space-y-2.5">
                <div class="notification bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg" data-id="notif1">
                    <div class="flex justify-between items-start"> <p class="text-sm font-medium text-[var(--text-primary)]">System Update Available</p> <button class="text-xs text-[var(--icon-color)] hover:text-[var(--text-primary)] dismiss-notification" title="Dismiss">&times;</button> </div>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">Important security updates are ready.</p>
                    <button class="text-xs mt-2 action-button" onclick="showTemporaryMessage('Initiating system update...', 2000)">Install Update</button>
                </div>
                 <div class="notification bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg" data-id="notif3">
                    <div class="flex justify-between items-start"> <p class="text-sm font-medium text-[var(--text-primary)]">Backup Completed</p> <button class="text-xs text-[var(--icon-color)] hover:text-[var(--text-primary)] dismiss-notification" title="Dismiss">&times;</button> </div>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">Files successfully backed up at 3:05 AM.</p>
                </div>
                <div class="notification bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg" data-id="notif4">
                    <div class="flex justify-between items-start"> <p class="text-sm font-medium text-[var(--text-primary)]">New Email: Project Alpha</p> <button class="text-xs text-[var(--icon-color)] hover:text-[var(--text-primary)] dismiss-notification" title="Dismiss">&times;</button> </div>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">"Just wanted to follow up on..."</p>
                    <button class="text-xs mt-2 action-button" onclick="launchOrFocusApp('mail-client')">Open Mail</button>
                </div>
                 <div class="notification bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg" data-id="notif5">
                    <div class="flex justify-between items-start"> <p class="text-sm font-medium text-[var(--text-primary)]">Disk Space Low</p> <button class="text-xs text-[var(--icon-color)] hover:text-[var(--text-primary)] dismiss-notification" title="Dismiss">&times;</button> </div>
                    <p class="text-xs text-[var(--text-secondary)] mt-1">Your /home partition is 95% full.</p>
                </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h2>Quick Controls</h2>
            <div class="grid grid-cols-2 gap-3">
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="toggleQuickSetting(this, 'Wi-Fi')"> <i class="fas fa-wifi text-xl text-[var(--accent-color)]"></i> <span class="text-xs">Wi-Fi</span><span class="text-xs text-[var(--secondary-accent)] hidden">On</span> </button>
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="toggleQuickSetting(this, 'Bluetooth')"> <i class="fab fa-bluetooth-b text-xl text-[var(--accent-color)]"></i> <span class="text-xs">Bluetooth</span><span class="text-xs text-[var(--error-color)]">Off</span> </button>
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="toggleQuickSetting(this, 'Night Mode')"> <i class="fas fa-moon text-xl text-yellow-500"></i> <span class="text-xs">Night Mode</span><span class="text-xs text-[var(--error-color)]">Off</span> </button>
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="changeWallpaperContext(true)"> <i class="fas fa-palette text-xl text-purple-400"></i> <span class="text-xs">Wallpaper</span> </button>
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="toggleDockTransparency()"> <i class="fas fa-adjust text-xl text-teal-400"></i> <span class="text-xs">Dock Glass</span><span id="dock-transparency-label" class="text-xs text-[var(--text-secondary)]">Med</span> </button>
                <button class="sidebar-icon bg-[var(--surface-overlay-bg)] p-3 rounded-xl flex flex-col items-center space-y-1" onclick="toggleWindowTransparency()"> <i class="fas fa-layer-group text-xl text-cyan-400"></i> <span class="text-xs">Win Glass</span><span id="window-transparency-label" class="text-xs text-[var(--text-secondary)]">Off</span> </button>
            </div>
        </div>
         <div class="sidebar-section">
            <h2>Weather</h2>
            <div id="sidebar-weather-container" class="bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg text-sm">
                <div class="flex items-center mb-1">
                    <i id="sidebar-weather-icon" class="fas fa-cloud-sun text-2xl mr-2 text-yellow-400"></i>
                    <div>
                        <p id="sidebar-weather-city" class="font-medium text-[var(--text-primary)]">Loading...</p>
                        <p id="sidebar-weather-temp" class="text-xl text-[var(--text-primary)]">--°F</p>
                    </div>
                </div>
                <p id="sidebar-weather-condition" class="text-xs text-[var(--text-secondary)]">Fetching data...</p>
                <button class="text-xs mt-2 action-button !py-1 !px-2" onclick="updateSidebarWeather(true)">
                    <i class="fas fa-sync-alt text-xs"></i> Refresh
                </button>
            </div>
        </div>
         <div class="sidebar-section">
            <h2>Quick Links</h2>
            <div id="quick-links-container" class="space-y-1.5">
                <a href="https://news.google.com" target="_blank" class="sidebar-list-item flex items-center"><i class="fas fa-newspaper"></i> Google News</a>
                <a href="https://developer.mozilla.org" target="_blank" class="sidebar-list-item flex items-center"><i class="fab fa-firefox-browser"></i> MDN Web Docs</a>
                <a href="https://github.com" target="_blank" class="sidebar-list-item flex items-center"><i class="fab fa-github"></i> GitHub</a>
                <a href="https://stackoverflow.com" target="_blank" class="sidebar-list-item flex items-center"><i class="fab fa-stack-overflow"></i> Stack Overflow</a>
                <a href="https://reddit.com/r/linux" target="_blank" class="sidebar-list-item flex items-center"><i class="fab fa-reddit-alien"></i> r/linux</a>
                <a href="https://osweb.dev/docs" target="_blank" class="sidebar-list-item flex items-center"><i class="fas fa-book-open"></i> OSWeb Docs</a>
            </div>
        </div>
        <div class="sidebar-section">
            <h2>System News</h2>
            <div id="system-news-container" class="space-y-2">
                <div class="sidebar-list-item !cursor-default"> <p class="text-sm font-medium text-[var(--text-primary)]">Kernel Update Released</p> <p class="text-xs text-[var(--text-secondary)] mt-0.5">Version 6.5.2 brings new hardware support and security fixes. Consider updating soon.</p> </div>
                <div class="sidebar-list-item !cursor-default"> <p class="text-sm font-medium text-[var(--text-primary)]">Community Meetup Next Week</p> <p class="text-xs text-[var(--text-secondary)] mt-0.5">Join us online for the latest OS developments and Q&A.</p> </div>
                <div class="sidebar-list-item !cursor-default"> <p class="text-sm font-medium text-[var(--text-primary)]">New App: Photo Pro</p> <p class="text-xs text-[var(--text-secondary)] mt-0.5">Advanced photo editing now available in the App Launcher!</p> </div>
            </div>
        </div>
        <div class="sidebar-section">
            <h2>System Info</h2>
            <div id="system-info-container" class="space-y-1 text-xs text-[var(--text-secondary)]">
                <p><strong>OS Version:</strong> <span id="os-version-info">OSWeb v1.alpha3</span></p>
                <p><strong>User:</strong> <span id="user-info">OS User (Admin)</span></p>
                <p><strong>Uptime:</strong> <span id="system-uptime">0d 0h 0m</span></p>
            </div>
        </div>
        <div class="sidebar-section"> 
            <h2>Calendar</h2> 
            <div class="bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] p-3 rounded-lg text-sm"> 
                <div class="flex justify-between items-center font-medium mb-1.5"> 
                    <button id="cal-prev" class="top-panel-item p-1.5 rounded-full"><i class="fas fa-chevron-left text-xs"></i></button> 
                    <span id="cal-month-year">May 2025</span> 
                    <button id="cal-next" class="top-panel-item p-1.5 rounded-full"><i class="fas fa-chevron-right text-xs"></i></button> 
                </div> 
                <div id="cal-days" class="grid grid-cols-7 text-center text-xs gap-0.5"></div> 
            </div> 
        </div>
    </aside>

    <div id="context-menu" class="context-menu surface-card"></div>
    <div id="temp-message-container" class="temp-message"></div>
    <div id="custom-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[10001] hidden p-4">
        <div class="bg-[var(--surface-bg)] p-6 rounded-lg shadow-xl max-w-sm w-full">
            <h3 id="custom-modal-title" class="text-lg font-medium text-[var(--text-primary)] mb-3">Confirmation</h3>
            <p id="custom-modal-message" class="text-sm text-[var(--text-secondary)] mb-4">Are you sure?</p>
            <div class="flex justify-end space-x-3">
                <button id="custom-modal-cancel" class="action-button !bg-gray-500 hover:!bg-gray-600 !text-white px-4 py-2 rounded-md">Cancel</button>
                <button id="custom-modal-confirm" class="action-button px-4 py-2 rounded-md">Confirm</button>
            </div>
        </div>
    </div>

    <div id="login-modal" class="fixed inset-0 z-[20000] flex items-center justify-content-center bg-black bg-opacity-70 backdrop-blur-sm">
        <div class="bg-[var(--surface-bg)] p-8 rounded-lg shadow-2xl w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-[var(--text-primary)] mb-6">Welcome to OSWeb v1</h2>
            <input type="text" id="username-input" placeholder="Enter username" class="w-full p-3 mb-4 rounded-md border border-[var(--border-color)] bg-[var(--primary-bg)] text-[var(--text-primary)] outline-none focus:ring-2 focus:ring-[var(--accent-color)]">
            <button id="login-button" class="w-full action-button text-lg py-3 rounded-md">Login / Continue</button>
            <p class="text-xs text-[var(--text-secondary)] mt-4">Enter any username to start or resume your session.</p>
        </div>
    </div>


    <script>
        // --- Global State & Config ---
        let activeWindowId = null; 
        let highestZIndex = 10;
        const openWindows = {}; 
        let currentWallpaperIdx = 3; 
        const wallpapers = [ // Added more wallpapers
            { name: 'Mountain Vista', url: 'https://wallpapercat.com/w/full/a/2/d/1165785-1920x1080-desktop-full-hd-landscape-background.jpg' },
            { name: 'Mountain Vista', url: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Cosmic Swirl', url: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Aurora Borealis', url: 'https://images.unsplash.com/photo-1531366936337-7c912a4589a7?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Lush Forest Canopy', url: 'https://images.unsplash.com/photo-1448375240586-882707db888b?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Tranquil Beach', url: 'https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Geometric Abstract', url: 'https://images.unsplash.com/photo-1518655048521-f130df041f66?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Desert Dunes', url: 'https://images.unsplash.com/photo-1473580044384-7ba9967e16a0?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' },
            { name: 'Starry Night Sky', url: 'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?ixlib=rb-4.0.3&q=85&fm=jpg&crop=entropy&cs=srgb&w=1920' }
        ];
        let nextWidgetId = 1;
        const MIN_WINDOW_WIDTH = 320; 
        const MIN_WINDOW_HEIGHT = 240;
        
        let virtualDesktops = [1, 2, 3]; 
        let nextDesktopId = 4; 
        let currentVirtualDesktop = 1;

        let windowInstanceCounter = {}; 
        let longPressTimer = null;
        const LONG_PRESS_DURATION = 500;
        
        const themes = ['indigo-magic-theme', 'light-mode', 'crimson-peak-theme', 'default-dark'];
        let currentThemeIndex = 0; 
        
        let activeMenuBarDropdown = null; 
        const dockTransparencyLevels = [
            { label: 'Off', value: 1.0 }, { label: 'Low', value: 0.9 },
            { label: 'Med', value: 0.75 }, { label: 'High', value: 0.5 }
        ];
        let currentDockTransparencyIndex = 3; // Default to High

        const windowTransparencyLevels = [
            { label: 'Off', value: 1.0 }, { label: 'Low', value: 0.9 },
            { label: 'Med', value: 0.75 }, { label: 'High', value: 0.6 }, // Default to High
            { label: 'Glass', value: 0.01 } 
        ];
        let currentWindowTransparencyIndex = 3; // Default to High

        let systemStartTime = null; 
        let currentUsername = null;
        const OS_VERSION = "OSWeb v1.beta2"; // Updated version
        
        let terminalCommandHistory = [];
        let terminalHistoryIndex = -1;
        let currentTerminalPath = "~"; // For mock `cd` command
        const mockFileSystem = { // Basic mock file system for `ls`, `cd`, `cat`, `tree`
            "~": { type: "dir", content: ["Desktop", "Documents", "Downloads", "Music", "Pictures", "Videos", ".bashrc"] },
            "~/Desktop": { type: "dir", content: ["screenshot.png", "notes.txt"] },
            "~/Documents": { type: "dir", content: ["ProjectAlpha", "report.docx"] },
            "~/Documents/ProjectAlpha": { type: "dir", content: ["README.md", "main.py"] },
            "~/Downloads": { type: "dir", content: ["installer.exe", "archive.zip"] },
            "~/Music": { type: "dir", content: ["song1.mp3", "album_art.jpg"] },
            "~/Pictures": { type: "dir", content: ["vacation_2025", "profile.jpg"] },
            "~/Pictures/vacation_2025": { type: "dir", content: ["img_001.jpg", "img_002.jpg"] },
            "~/Videos": { type: "dir", content: ["tutorial.mp4"] },
            "~/.bashrc": { type: "file", content: "# OSWeb Bash Config\n\nPS1='\\u@\\h:\\w\\$ '\n\nalias ll='ls -laH'" },
            "~/Desktop/notes.txt": { type: "file", content: "Quick notes for OSWeb demo.\n- Add more features\n- Test thoroughly" },
            "~/Documents/ProjectAlpha/README.md": { type: "file", content: "# Project Alpha\nThis is a mock project." }
        };


        // --- App Initialization Functions ---
        function initCalculator(windowEl) {
            calcDisplayElement = windowEl.querySelector('#calc-output');
            const buttons = windowEl.querySelectorAll('.calc-button');
            buttons.forEach(button => {
                button.addEventListener('click', () => {
                    const value = button.dataset.value; const op = button.dataset.op;
                    if (value) calcAppend(value);
                    else if (op) { if (op === 'C') calcClear(); else if (op === '=') calcEquals(); else calcPerformOp(op); }
                });
            });
            calcClear();
        }
        function initNotepad(windowEl) {
            const summarizeBtn = windowEl.querySelector('#summarize-note-btn');
            const suggestTitleBtn = windowEl.querySelector('#suggest-title-btn');
            const textarea = windowEl.querySelector('textarea');

            if (summarizeBtn) {
                summarizeBtn.onclick = async () => {
                    const noteContent = textarea.value;
                    if (!noteContent.trim()) { showTemporaryMessage("Note is empty, nothing to summarize.", 2000); return; }
                    summarizeBtn.disabled = true; summarizeBtn.innerHTML = '✨ Summarizing<span class="loading-spinner"></span>';
                    const summary = await callGeminiAPI(`Summarize the following note concisely:\n\n${noteContent}`);
                    textarea.value += `\n\n--- Summary ---\n${summary.trim()}`;
                    summarizeBtn.disabled = false; summarizeBtn.innerHTML = '✨ Summarize';
                    showTemporaryMessage("Summary appended.", 2000);
                };
            }
            if (suggestTitleBtn) {
                suggestTitleBtn.onclick = async () => {
                    const noteContent = textarea.value;
                    if (!noteContent.trim()) { showTemporaryMessage("Note is empty, cannot suggest a title.", 2000); return; }
                    suggestTitleBtn.disabled = true; suggestTitleBtn.innerHTML = '✨ Suggesting<span class="loading-spinner"></span>';
                    const title = await callGeminiAPI(`Suggest a very short, concise title (3-5 words max) for the following note (title only, no extra explanation):\n\n${noteContent}`);
                    if (!textarea.value.trim().toLowerCase().includes(title.trim().toLowerCase())) {
                         textarea.value = `${title.trim()}\n--------------------\n${noteContent}`;
                    } else { showTemporaryMessage(`Title Suggestion: ${title.trim()}`, 3000); }
                    suggestTitleBtn.disabled = false; suggestTitleBtn.innerHTML = '✨ Suggest Title';
                };
            }
        }
        let lastTerminalCommand = ""; 
        function initTerminal(windowEl) {
            const inputEl = windowEl.querySelector('.terminal-input');
            const outputEl = windowEl.querySelector('.terminal-output');
            const promptSpan = windowEl.querySelector('.terminal-prompt-span');

            currentTerminalPath = `~`; // Reset path for new terminal
            if(promptSpan) promptSpan.textContent = `${currentUsername || 'user'}@osweb:${currentTerminalPath}$ `;
            outputEl.innerHTML = `<div>Welcome to OSWeb Terminal. Type 'help' for commands.</div>`;
            
            inputEl.addEventListener('keydown', async (e) => { // Changed to keydown for better history/tab control
                if (e.key === 'Enter' && inputEl.value.trim() !== '') {
                    e.preventDefault();
                    const fullCommand = inputEl.value.trim();
                    lastTerminalCommand = fullCommand; 
                    if (fullCommand && (!terminalCommandHistory.length || terminalCommandHistory[terminalCommandHistory.length - 1] !== fullCommand)) {
                        terminalCommandHistory.push(fullCommand);
                    }
                    terminalHistoryIndex = terminalCommandHistory.length; // Reset history index
                    inputEl.value = '';
                    outputEl.innerHTML += `<div><span class="prompt">${currentUsername || 'user'}@osweb:${currentTerminalPath}$ </span><span class="command">${fullCommand.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span></div>`;
                    outputEl.scrollTop = outputEl.scrollHeight;

                    const parts = fullCommand.split(' ');
                    const command = parts[0].toLowerCase();
                    const args = parts.slice(1);
                    let response = '';

                    if (command === 'explain') {
                        const commandToExplain = args.join(' ');
                        if(commandToExplain){
                            outputEl.innerHTML += `<div><span class="explanation">Requesting explanation for: ${commandToExplain.replace(/</g, "&lt;").replace(/>/g, "&gt;")}...</span></div>`;
                            outputEl.scrollTop = outputEl.scrollHeight;
                            const explanation = await callGeminiAPI(`Explain the following Linux/bash command simply and concisely: ${commandToExplain}`);
                            response = `<span class="explanation">${explanation.replace(/\n/g, "<br>")}</span>`;
                        } else { response = `<span class="error">Usage: explain [command]</span>`; }
                    } else if (command === 'man') {
                        const commandToMan = args.join(' ');
                        if(commandToMan){
                            outputEl.innerHTML += `<div><span class="explanation">Fetching manual for: ${commandToMan.replace(/</g, "&lt;").replace(/>/g, "&gt;")}...</span></div>`;
                            outputEl.scrollTop = outputEl.scrollHeight;
                            const explanation = await callGeminiAPI(`Explain the Linux command '${commandToMan}' concisely, as if it were a man page summary.`);
                            response = `<span class="explanation">${explanation.replace(/\n/g, "<br>")}</span>`;
                        } else { response = `<span class="error">Usage: man [command]</span>`; }
                    } else {
                         // --- Enhanced Terminal Commands ---
                        switch (command) {
                            case 'help': response = "Commands: ls, cd, pwd, cat, echo, clear, exit, date, uname, whoami, neofetch, history, man, uptime, df, free, ip, cal, time, mkdir, touch, rm, cp, mv, grep, find, users, groups, ps, kill, tree, less, sudo, reboot, shutdown. Use 'explain [cmd]' for details."; break;
                            case 'ls': {
                                const targetPath = args[0] ? resolvePath(args[0]) : currentTerminalPath;
                                const item = mockFileSystem[targetPath];
                                if (item && item.type === "dir") {
                                    response = item.content.map(name => {
                                        const fullItemPath = targetPath === "~" ? `~/${name}` : `${targetPath}/${name}`;
                                        return mockFileSystem[fullItemPath]?.type === "dir" ? `<span style="color:var(--accent-color);">${name}/</span>` : name;
                                    }).join('&nbsp;&nbsp;&nbsp;');
                                } else if (item && item.type === "file") {
                                    response = args[0]; // ls on a file just shows the file name
                                } else { response = `<span class="error">ls: cannot access '${args[0] || '.'}': No such file or directory</span>`; }
                                break;
                            }
                            case 'cd': {
                                if (!args[0]) { currentTerminalPath = "~"; } 
                                else {
                                    const newPath = resolvePath(args[0]);
                                    if (mockFileSystem[newPath] && mockFileSystem[newPath].type === "dir") {
                                        currentTerminalPath = newPath;
                                    } else { response = `<span class="error">cd: ${args[0]}: No such file or directory</span>`; }
                                }
                                if(promptSpan) promptSpan.textContent = `${currentUsername || 'user'}@osweb:${currentTerminalPath}$ `;
                                break;
                            }
                            case 'pwd': response = currentTerminalPath.startsWith("~") ? `/home/${currentUsername || 'user'}${currentTerminalPath.substring(1)}` : currentTerminalPath; break;
                            case 'cat': {
                                if (!args[0]) { response = `<span class="error">cat: missing operand</span>`; break; }
                                const filePath = resolvePath(args[0]);
                                const file = mockFileSystem[filePath];
                                if (file && file.type === "file") { response = file.content.replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/\n/g, "<br>"); }
                                else if (file && file.type === "dir") { response = `<span class="error">cat: ${args[0]}: Is a directory</span>`; }
                                else { response = `<span class="error">cat: ${args[0]}: No such file or directory</span>`; }
                                break;
                            }
                            case 'echo': response = args.join(' ').replace(/</g, "&lt;").replace(/>/g, "&gt;") || ''; break;
                            case 'clear': outputEl.innerHTML = ''; return;
                            case 'exit': closeWindow(windowEl.id); return;
                            case 'date': response = new Date().toString(); break;
                            case 'uname': response = args[0] === '-a' ? `OSWeb Kernel v1.0 ${OS_VERSION} GNU/Linux (mock)` : `OSWeb (mock)`; break;
                            case 'whoami': response = currentUsername || 'user'; break;
                            case 'neofetch':
                                const uptimeText = systemUptimeEl ? systemUptimeEl.textContent : 'N/A';
                                const cpuText = cpuMeter ? cpuMeter.textContent.split(': ')[1] : 'N/A';
                                const gpuText = gpuMeter ? gpuMeter.textContent.split(': ')[1] : 'N/A';
                                const currentThemeName = themes[currentThemeIndex].replace('-theme','').replace('-mode','').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                                response = `<div class="neofetch-art">
    .--.      <span class="neofetch-label">${currentUsername || 'user'}@osweb</span>
   |o_o |     -------------
   |:_/ |     <span class="neofetch-label">OS</span>: OSWeb ${OS_VERSION}
  //   \\ \\    <span class="neofetch-label">Kernel</span>: OSWeb Kernel v1.0
 (|     | )   <span class="neofetch-label">Uptime</span>: ${uptimeText}
/'\\_   _/ \`\\  <span class="neofetch-label">Shell</span>: bash (mock)
\\___)=(___/   <span class="neofetch-label">Terminal</span>: OSWeb Terminal
              <span class="neofetch-label">CPU</span>: ${cpuText} (mock)
              <span class="neofetch-label">GPU</span>: ${gpuText} (mock)
              <span class="neofetch-label">Theme</span>: ${currentThemeName}
</div>`;
                                break;
                            case 'history': response = terminalCommandHistory.map((cmd, i) => `${i + 1}. ${cmd.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`).join('<br>'); break;
                            case 'uptime': response = systemUptimeEl ? ` ${systemUptimeEl.textContent},  1 user,  load average: 0.15, 0.20, 0.25 (mock)` : 'Uptime data not available.'; break;
                            case 'df': response = args[0] === '-h' ? 'Filesystem &nbsp;&nbsp;Size &nbsp;Used Avail Use% Mounted on<br>/dev/osweb &nbsp;&nbsp;&nbsp;100G &nbsp;&nbsp;20G &nbsp;&nbsp;80G &nbsp;20% / (mock)' : 'Filesystem 1K-blocks Used Available Use% Mounted on<br>/dev/osweb 104857600 20971520 83886080 20% / (mock)'; break;
                            case 'free': response = args[0] === '-m' ? ' &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;total &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;used &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;free &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shared &nbsp;buff/cache &nbsp;available<br>Mem: &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;7980 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1250 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5700 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;150 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1030 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6500 (mock MB)' : 'total used free ... (mock KB)'; break;
                            case 'ip': response = (args[0] === 'addr' || args[0] === 'a') ? '1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000<br>&nbsp;&nbsp;&nbsp;&nbsp;link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00<br>&nbsp;&nbsp;&nbsp;&nbsp;inet 127.0.0.1/8 scope host lo<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid_lft forever preferred_lft forever<br>2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000<br>&nbsp;&nbsp;&nbsp;&nbsp;link/ether 02:42:ac:11:00:02 brd ff:ff:ff:ff:ff:ff<br>&nbsp;&nbsp;&nbsp;&nbsp;inet 192.168.1.101/24 brd 192.168.1.255 scope global dynamic eth0<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; valid_lft 86300sec preferred_lft 86300sec (mock)' : 'Usage: ip addr (mock)'; break;
                            case 'cal': { const d = new Date(); response = `&nbsp;&nbsp;&nbsp; ${d.toLocaleString('default', { month: 'long' })} ${d.getFullYear()}<br>Su Mo Tu We Th Fr Sa<br>${Array(new Date(d.getFullYear(), d.getMonth(), 1).getDay()).fill('&nbsp;&nbsp; ').join('')}${Array.from({length: new Date(d.getFullYear(), d.getMonth()+1,0).getDate()}, (_,i)=>String(i+1).padStart(2,' ')).join(' ').replace(new RegExp(`(${String(d.getDate()).padStart(2,' ')})`), `<span style="background:var(--text-secondary);color:var(--surface-bg);border-radius:2px;">$1</span>`).replace(/(.{20})/g, '$1<br>')}`; break; } // Basic calendar
                            case 'time': response = `Real time: 0m${(Math.random()*10).toFixed(3)}s<br>User time: 0m${(Math.random()*2).toFixed(3)}s<br>Sys time: 0m${(Math.random()*1).toFixed(3)}s (mock)`; break;
                            case 'mkdir': response = args.length > 0 ? `Created directory: ${args[0].replace(/</g, "&lt;").replace(/>/g, "&gt;")}` : 'Usage: mkdir &lt;dirname&gt;'; break;
                            case 'touch': response = args.length > 0 ? `Created file: ${args[0].replace(/</g, "&lt;").replace(/>/g, "&gt;")}` : 'Usage: touch &lt;filename&gt;'; break;
                            case 'rm': response = args.length > 0 ? `Removed ${args[0].replace(/</g, "&lt;").replace(/>/g, "&gt;")} (mock)` : 'Usage: rm &lt;filename&gt;'; break;
                            case 'cp': response = args.length > 1 ? `Copied ${args[0]} to ${args[1]} (mock)` : 'Usage: cp &lt;source&gt; &lt;destination&gt;'; break;
                            case 'mv': response = args.length > 1 ? `Moved ${args[0]} to ${args[1]} (mock)` : 'Usage: mv &lt;source&gt; &lt;destination&gt;'; break;
                            case 'grep': response = args.length > 1 ? `(mock grep results for "${args[0]}" in ${args[1]})` : 'Usage: grep &lt;pattern&gt; &lt;file&gt;'; break;
                            case 'find': response = args.length > 0 ? `(mock find results for ${args.join(' ')})` : 'Usage: find &lt;path&gt; -name &lt;pattern&gt;'; break;
                            case 'users': response = `${currentUsername || 'user'}`; break;
                            case 'groups': response = `${currentUsername || 'user'} adm cdrom sudo dip plugdev lpadmin (mock)`; break;
                            case 'ps': response = args[0] === 'aux' ? `USER &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PID %CPU %MEM &nbsp;&nbsp;VSZ &nbsp;RSS TTY &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;STAT START &nbsp;TIME COMMAND<br>root &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 &nbsp;0.0 &nbsp;0.1 &nbsp;1600 &nbsp;800 ? &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Ss &nbsp;&nbsp;10:00 &nbsp;0:00 /sbin/init<br>${currentUsername || 'user'} &nbsp;1234 &nbsp;0.5 &nbsp;1.2 32000 9600 pts/0 &nbsp;&nbsp;S+ &nbsp;&nbsp;10:05 &nbsp;0:02 bash (mock)` : 'PID TTY &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TIME CMD<br>1234 pts/0 &nbsp;&nbsp;&nbsp;&nbsp;00:00:02 bash (mock)'; break;
                            case 'kill': response = args.length > 0 ? `Sent signal to process ${args[0]} (mock)` : 'Usage: kill &lt;pid&gt;'; break;
                            case 'tree': {
                                const targetPath = args[0] ? resolvePath(args[0]) : currentTerminalPath;
                                response = generateTree(targetPath, 0);
                                if (!response) response = `<span class="error">tree: '${args[0] || '.'}' not found or not a directory.</span>`;
                                break;
                            }
                            case 'less': response = args.length > 0 ? `Opening ${args[0]} in less (mock)... Press 'q' to quit.` : 'Usage: less <file>'; break;
                            case 'sudo': response = `<span class="error">Error: '${currentUsername || 'user'}' is not in the sudoers file. This incident will be reported. (Just kidding!)</span>`; break;
                            case 'reboot': response = 'System is going down for reboot NOW! (mock - closing terminal)'; setTimeout(() => closeWindow(windowEl.id), 1000); break;
                            case 'shutdown': response = 'System is halting. (mock - closing terminal)'; setTimeout(() => closeWindow(windowEl.id), 1000); break;
                            default: response = `<span class="error">Command not found: ${command.replace(/</g, "&lt;").replace(/>/g, "&gt;")}. Type 'help'.</span>`;
                        }
                    }
                    outputEl.innerHTML += `<div><span class="response">${response}</span></div>`;
                    outputEl.scrollTop = outputEl.scrollHeight;
                } else if (e.key === "ArrowUp") {
                    e.preventDefault();
                    if (terminalCommandHistory.length > 0) {
                        terminalHistoryIndex = Math.max(0, terminalHistoryIndex - 1);
                        inputEl.value = terminalCommandHistory[terminalHistoryIndex] || "";
                        inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length); // Move cursor to end
                    }
                } else if (e.key === "ArrowDown") {
                    e.preventDefault();
                    if (terminalHistoryIndex < terminalCommandHistory.length -1) {
                        terminalHistoryIndex++;
                        inputEl.value = terminalCommandHistory[terminalHistoryIndex] || "";
                    } else {
                        terminalHistoryIndex = terminalCommandHistory.length;
                        inputEl.value = "";
                    }
                    inputEl.setSelectionRange(inputEl.value.length, inputEl.value.length);
                } else if (e.key === "Tab") {
                    e.preventDefault();
                    const currentInput = inputEl.value;
                    const lastWord = currentInput.split(" ").pop();
                    if (!lastWord) return;

                    const isCommandStart = currentInput.split(" ").length === 1 && !currentInput.includes(" ");
                    
                    let suggestions = [];
                    if (isCommandStart) { // Suggest commands
                        suggestions = Object.keys(appConfig) // Suggest apps first
                            .filter(appId => appId.startsWith(lastWord))
                            .map(appId => appId) // Use appId as command
                            .concat(
                                ["ls", "cd", "pwd", "cat", "echo", "clear", "exit", "date", "uname", "whoami", "neofetch", "history", "man", "uptime", "df", "free", "ip", "cal", "time", "mkdir", "touch", "rm", "cp", "mv", "grep", "find", "users", "groups", "ps", "kill", "tree", "less", "sudo", "reboot", "shutdown", "explain"]
                                .filter(cmd => cmd.startsWith(lastWord))
                            );
                    } else { // Suggest file/dir paths
                        const currentDirItems = mockFileSystem[currentTerminalPath]?.content || [];
                        suggestions = currentDirItems.filter(item => item.toLowerCase().startsWith(lastWord.toLowerCase()));
                    }

                    if (suggestions.length === 1) {
                        const parts = currentInput.split(" ");
                        parts.pop(); 
                        parts.push(suggestions[0] + (mockFileSystem[resolvePath(suggestions[0])]?.type === "dir" && !isCommandStart ? "/" : " "));
                        inputEl.value = parts.join(" ");
                    } else if (suggestions.length > 1) {
                        outputEl.innerHTML += `<div><span class="prompt">${currentUsername || 'user'}@osweb:${currentTerminalPath}$ </span><span class="command">${currentInput}</span></div>`;
                        outputEl.innerHTML += `<div><span class="response">${suggestions.join("  ")}</span></div>`;
                        outputEl.scrollTop = outputEl.scrollHeight;
                    }
                }
            });
            inputEl.focus();
        }
        function resolvePath(path) { // Helper for cd and ls
            if (path === "~" || path.startsWith("~/")) return path; // Absolute from home
            if (path.startsWith("/")) return path; // Absolute from root (not really supported, treat as relative to ~)
            
            let parts = currentTerminalPath.split("/").filter(p => p);
            if (currentTerminalPath === "~") parts = ["~"];

            const pathParts = path.split("/").filter(p => p);
            for (const part of pathParts) {
                if (part === ".") continue;
                if (part === "..") {
                    if (parts.length > 1 && parts[parts.length -1] !== "~") parts.pop();
                    else if (parts.length === 1 && parts[0] !== "~") parts.pop(); // Handle if at root-like level
                } else {
                    parts.push(part);
                }
            }
            if (parts.length === 1 && parts[0] === "~") return "~";
            if (parts[0] === "~") return parts.join("/");
            return "~/" + parts.join("/"); // Default to home relative if path becomes odd
        }
        function generateTree(path, depth, prefix = "") {
            const item = mockFileSystem[path];
            if (!item || item.type !== "dir" || depth > 3) return ""; // Limit depth for sanity
            let output = "";
            const entries = item.content;
            entries.forEach((entry, index) => {
                const entryPath = path === "~" ? `~/${entry}` : `${path}/${entry}`;
                const entryItem = mockFileSystem[entryPath];
                const isLast = index === entries.length - 1;
                const connector = isLast ? "└── " : "├── ";
                const entryName = entryItem?.type === "dir" ? `<span style="color:var(--accent-color);">${entry}/</span>` : entry;
                output += `<div class="tree-item ${isLast ? 'last' : ''}">${prefix}${connector}${entryName}</div>`;
                if (entryItem && entryItem.type === "dir") {
                    output += generateTree(entryPath, depth + 1, prefix + (isLast ? "    " : "│   "));
                }
            });
            return output;
        }

        function initAIAssistant(windowEl) {
            const inputEl = windowEl.querySelector('#ai-command-input');
            const chatLogEl = windowEl.querySelector('#ai-chat-log');
            chatLogEl.innerHTML = `<div class="text-left my-1"><span class="bg-[var(--surface-overlay-bg)] text-[var(--text-primary)] px-2.5 py-1.5 rounded-lg text-xs inline-block">Hello! I'm your OS Assistant. How can I help?</span></div>`;
            inputEl.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && inputEl.value.trim() !== '') {
                    const query = inputEl.value.trim();
                    chatLogEl.innerHTML += `<div class="text-right my-1.5"><span class="bg-[var(--accent-color)] text-[var(--primary-bg)] px-2.5 py-1.5 rounded-lg text-xs inline-block">${query}</span></div>`;
                    inputEl.value = ''; inputEl.disabled = true; chatLogEl.scrollTop = chatLogEl.scrollHeight;
                    const thinkingElId = `thinking-${Date.now()}`;
                    chatLogEl.innerHTML += `<div class="text-left my-1.5" id="${thinkingElId}"><span class="bg-[var(--surface-overlay-bg)] text-[var(--text-primary)] px-2.5 py-1.5 rounded-lg text-xs inline-block">Assistant is thinking<span class="loading-spinner"></span></span></div>`;
                    chatLogEl.scrollTop = chatLogEl.scrollHeight;
                    const response = await callGeminiAPI(query);
                    const thinkingEl = document.getElementById(thinkingElId); if(thinkingEl) thinkingEl.remove();
                    chatLogEl.innerHTML += `<div class="text-left my-1.5"><span class="bg-[var(--surface-overlay-bg)] text-[var(--text-primary)] px-2.5 py-1.5 rounded-lg text-xs inline-block">${response.replace(/\n/g, "<br>")}</span></div>`;
                    chatLogEl.scrollTop = chatLogEl.scrollHeight; inputEl.disabled = false; inputEl.focus();
                }
            });
        }
        function initWebBrowser(windowEl, initialUrlFromCreate = null) {
            const addressBar = windowEl.querySelector('#browser-address-bar');
            const goButton = windowEl.querySelector('#browser-go-button');
            const contentFrame = windowEl.querySelector('#browser-content-frame');
            const lockIcon = windowEl.querySelector('#browser-lock-icon');

            function navigateTo(urlToLoad) {
                let url = urlToLoad.trim();
                if (!url) return;
                if (!url.startsWith('http://') && !url.startsWith('https://') && !url.startsWith('data:')) {
                    url = 'https://' + url;
                }
                addressBar.value = url; 
                
                if (url.startsWith('data:')) { 
                     try { contentFrame.src = url; } catch (e) { console.error("Error loading data URI:", e); contentFrame.src = 'about:blank';}
                } else { 
                    window.open(url, '_blank'); 
                    contentFrame.src = `data:text/html,
                        <html style="height:100%;display:flex;align-items:center;justify-content:center;font-family:sans-serif;color:var(--text-secondary);background-color:var(--surface-bg);">
                            <body style="text-align:center;padding:20px;">
                                <p style="font-size:1.1em; color:var(--text-primary);">Opening in new tab:</p>
                                <p style="font-size:0.9em; word-break:break-all; margin-bottom:15px;">${url}</p>
                                <i class="fas fa-external-link-alt" style="font-size:2em; color:var(--accent-color); margin-bottom:15px;"></i>
                                <p style="font-size:0.8em;">(If it didn't open, please check your pop-up blocker)</p>
                            </body>
                        </html>`;
                }
                
                if (url.startsWith('https://')) {
                    lockIcon.className = 'fas fa-lock px-1 text-[var(--secondary-accent)]'; 
                } else if (url.startsWith('http://')) {
                    lockIcon.className = 'fas fa-unlock-alt px-1 text-[var(--warning-color)]'; 
                } else {
                     lockIcon.className = 'fas fa-info-circle px-1 text-[var(--icon-color)]';
                }
            }

            addressBar.addEventListener('keypress', (e) => { if (e.key === 'Enter') navigateTo(addressBar.value); });
            goButton.addEventListener('click', () => navigateTo(addressBar.value));
            
            if(initialUrlFromCreate) { 
                navigateTo(initialUrlFromCreate);
            } else { 
                contentFrame.src = `data:text/html,
                    <html style="height:100%;display:flex;align-items:center;justify-content:center;font-family:sans-serif;color:var(--text-secondary);background-color:var(--surface-bg);">
                        <body style="text-align:center;">
                            <i class="fas fa-globe-americas" style="font-size:3em; color:var(--accent-color); margin-bottom:15px;"></i>
                            <p style="font-size:1.2em;color:var(--text-primary);">OSWeb Browser Ready</p>
                            <p style="font-size:0.9em;">Type a URL above and press Enter or click Go.</p>
                        </body>
                    </html>`;
                lockIcon.className = 'fas fa-info-circle px-1 text-[var(--icon-color)]';
            }
        }
        function initMailClient(windowEl) {
            const firstFolder = windowEl.querySelector('.mail-sidebar-item');
            if (firstFolder) firstFolder.classList.add('active');
        }
        function initAppLauncher(windowEl) {
            const grid = windowEl.querySelector('#app-launcher-grid');
            if (!grid) return;
            grid.innerHTML = ''; 

            // Sort apps alphabetically by name, but keep "Settings" at the end if it exists
            const sortedAppIds = Object.keys(appConfig)
                .filter(appId => appId !== 'app-launcher') // Exclude the launcher itself
                .sort((a, b) => {
                    if (a === 'settings') return 1; // settings always last
                    if (b === 'settings') return -1; // settings always last
                    return appConfig[a].name.localeCompare(appConfig[b].name);
                });


            sortedAppIds.forEach(appId => {
                const app = appConfig[appId];
                const itemEl = document.createElement('div');
                itemEl.className = 'app-launcher-item';
                itemEl.innerHTML = `<i class="${app.icon}"></i><span>${app.name}</span>`;
                itemEl.onclick = () => {
                    launchOrFocusApp(appId); 
                    const launcherWindowId = Object.keys(openWindows).find(id => openWindows[id].appId === 'app-launcher');
                    if (launcherWindowId) {
                        closeWindow(launcherWindowId);
                    }
                };
                 itemEl.oncontextmenu = (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const desktopSubmenu = virtualDesktops.map(desktopNum => ({
                        label: `Desktop ${desktopNum}`,
                        icon: "fa-desktop",
                        action: () => {
                            createWindow(appId, {}, desktopNum);
                             const launcherWindowId = Object.keys(openWindows).find(id => openWindows[id].appId === 'app-launcher');
                            if (launcherWindowId) closeWindow(launcherWindowId);
                        }
                    }));
                    const launcherContextMenu = [
                        { label: "Open", icon: "fa-external-link-alt", action: () => { launchOrFocusApp(appId); const launcherWindowId = Object.keys(openWindows).find(id => openWindows[id].appId === 'app-launcher'); if (launcherWindowId) closeWindow(launcherWindowId); } },
                        { label: "Open on Desktop...", icon: "fa-ellipsis-h", items: desktopSubmenu, isSubmenuPlaceholder: true }, 
                    ];
                    displayContextMenu(e.clientX, e.clientY, launcherContextMenu, null, `launcher-${appId}`);
                };
                grid.appendChild(itemEl);
            });
        }
        function initClickerGame(windowEl) {
            const scoreEl = windowEl.querySelector('#clicker-score');
            const clickButton = windowEl.querySelector('#clicker-button');
            let score = 0;
            if (clickButton) {
                score = parseInt(clickButton.dataset.score || '0');
                if(scoreEl) scoreEl.textContent = score;

                clickButton.addEventListener('click', () => {
                    score++;
                    if(scoreEl) scoreEl.textContent = score;
                    clickButton.dataset.score = score; 
                });
            }
        }
        function initSystemMonitor(windowEl, isRefresh = false) {
            const cpuBar = windowEl.querySelector('#sysmon-cpu-bar');
            const memBar = windowEl.querySelector('#sysmon-mem-bar');

            const cpuUsage = Math.floor(Math.random() * 90) + 5;
            const memUsed = (Math.random() * 6 + 1).toFixed(1); 
            const memTotal = 8.0;
            const memPercent = Math.round((memUsed / memTotal) * 100);

            if (cpuBar) {
                cpuBar.style.width = `${cpuUsage}%`;
                cpuBar.textContent = `${cpuUsage}%`;
            }
            if (memBar) {
                memBar.style.width = `${memPercent}%`;
                memBar.textContent = `${memUsed}/${memTotal} GB`;
            }
        }
        function initSettingsApp(windowEl) {
            const sidebarItems = windowEl.querySelectorAll('.settings-sidebar-item');
            const contentPanes = windowEl.querySelectorAll('.settings-content-pane > div');

            sidebarItems.forEach(item => {
                item.addEventListener('click', () => {
                    sidebarItems.forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    const targetPaneId = item.dataset.pane;
                    contentPanes.forEach(pane => {
                        pane.classList.toggle('hidden', pane.id !== targetPaneId);
                    });
                });
            });
            // Activate the first pane by default
            if (sidebarItems.length > 0) sidebarItems[0].click();

            // Example: Theme changer in appearance
            const themeSelector = windowEl.querySelector('#settings-theme-selector');
            if (themeSelector) {
                themes.forEach((themeSlug, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = themeSlug.replace('-theme','').replace('-mode','').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    if (themeSlug === 'default-dark') option.textContent = "Default Dark";
                    themeSelector.appendChild(option);
                });
                themeSelector.value = currentThemeIndex;
                themeSelector.onchange = (e) => {
                    const newIndex = parseInt(e.target.value);
                    if (newIndex !== currentThemeIndex) {
                        // Simulate theme toggle button click logic
                        currentThemeIndex = newIndex;
                        document.body.className = ''; // Clear all body classes first
                        const newThemeSlug = themes[currentThemeIndex];
                         let themeUserFriendlyName = "";
                        if (newThemeSlug !== 'default-dark') document.body.classList.add(newThemeSlug);
                        
                        if (newThemeSlug === 'light-mode') themeUserFriendlyName = "Light";
                        else if (newThemeSlug === 'indigo-magic-theme') themeUserFriendlyName = "Indigo Magic";
                        else if (newThemeSlug === 'crimson-peak-theme') themeUserFriendlyName = "Crimson Peak";
                        else themeUserFriendlyName = "Default Dark";

                        const themeIcon = themeToggleButton.querySelector('i');
                        if (newThemeSlug === 'light-mode') { themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun');} 
                        else { themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon'); }
                        
                        const nextThemeIdx = (currentThemeIndex + 1) % themes.length;
                        let nextThemeName = themes[nextThemeIdx].replace('-theme','').replace('-mode','').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                        if (themes[nextThemeIdx] === 'default-dark') nextThemeName = "Default Dark";
                        themeToggleButton.title = `Switch to ${nextThemeName} Theme`;

                        showTemporaryMessage(`Theme changed to ${themeUserFriendlyName} via Settings.`, 1500);
                        updateUserAvatar(); applyDockTransparency(); applyWindowTransparency();
                    }
                };
            }
        }
        function initCalendarApp(windowEl) {
            const calMonthYearEl = windowEl.querySelector('.calendar-app-month-year');
            const calDaysGridEl = windowEl.querySelector('.calendar-app-days-grid');
            let calAppDate = new Date(); // Use current date for this app

            function renderCalApp() {
                if (!calMonthYearEl || !calDaysGridEl) return;
                calMonthYearEl.textContent = calAppDate.toLocaleDateString([], { month: 'long', year: 'numeric' });
                calDaysGridEl.innerHTML = ''; 
                const month = calAppDate.getMonth(); const year = calAppDate.getFullYear();
                const firstDayOfMonth = new Date(year, month, 1).getDay(); 
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(d => { 
                    const dayLabel = document.createElement('div'); 
                    dayLabel.className = 'text-center font-medium text-xs text-[var(--text-secondary)] py-1'; 
                    dayLabel.textContent = d; 
                    calDaysGridEl.appendChild(dayLabel); 
                });

                for (let i = 0; i < firstDayOfMonth; i++) calDaysGridEl.appendChild(document.createElement('div')); // Empty cells

                for (let day = 1; day <= daysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.className = 'border border-[var(--border-color)] p-1.5 text-xs hover:bg-[var(--surface-overlay-bg)] cursor-pointer min-h-[70px]';
                    dayCell.textContent = day;
                    const today = new Date();
                    if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) {
                        dayCell.classList.add('!bg-[var(--accent-color)]', '!text-[var(--primary-bg)]', 'font-bold');
                    }
                    dayCell.onclick = () => showTemporaryMessage(`Calendar App: Selected ${month+1}/${day}/${year}`,1500);
                    calDaysGridEl.appendChild(dayCell);
                }
            }
            windowEl.querySelector('.calendar-app-prev').onclick = () => { calAppDate.setMonth(calAppDate.getMonth() - 1); renderCalApp(); };
            windowEl.querySelector('.calendar-app-next').onclick = () => { calAppDate.setMonth(calAppDate.getMonth() + 1); renderCalApp(); };
            windowEl.querySelector('.calendar-app-today').onclick = () => { calAppDate = new Date(); renderCalApp(); };
            renderCalApp();
        }


        // --- App Configuration (with menuBar & contextMenuItems) ---
        const appConfig = {
            "app-launcher": { 
                name: "App Launcher", icon: "fas fa-th-large",
                content: `<div id="app-launcher-grid" class="app-launcher-grid"></div>`,
                allowMultiple: false, 
                initialWidth: 500, initialHeight: 400,
                initFunction: initAppLauncher,
                isPinnedToDock: true, // CHANGED: Now pinned to dock
                menuBar: [
                    { label: "File", items: [{ label: "Close Launcher", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : null }] },
                    { label: "View", items: [{ label: "Refresh Apps (mock)", icon: "fa-sync", action: () => showTemporaryMessage("App list refreshed (mock)", 1500) }] }
                ]
            },
            "file-explorer": { 
                name: "Files", icon: "fas fa-folder-open",
                content: `<div class="p-4 text-sm"><p class="mb-3 text-[var(--text-secondary)]">My Storage</p><div class="grid grid-cols-2 sm:grid-cols-3 gap-3"> <div class="bg-[var(--surface-overlay-bg)] p-4 rounded-lg text-center hover:bg-[var(--surface-active-bg)] cursor-pointer transition-all" onclick="showTemporaryMessage('Opening Documents folder...',1500)"><i class="fas fa-file-alt text-3xl mb-2 text-[var(--accent-color)]"></i> Documents</div> <div class="bg-[var(--surface-overlay-bg)] p-4 rounded-lg text-center hover:bg-[var(--surface-active-bg)] cursor-pointer transition-all" onclick="showTemporaryMessage('Opening Pictures folder...',1500)"><i class="fas fa-images text-3xl mb-2 text-[var(--secondary-accent)]"></i> Pictures</div> <div class="bg-[var(--surface-overlay-bg)] p-4 rounded-lg text-center hover:bg-[var(--surface-active-bg)] cursor-pointer transition-all" onclick="showTemporaryMessage('Opening Downloads folder...',1500)"><i class="fas fa-download text-3xl mb-2 text-orange-400"></i> Downloads</div></div></div>`, 
                allowMultiple: true, 
                isPinnedToDock: true,
                menuBar: [
                    { label: "File", items: [
                        { label: "New Window", icon: "fa-window-restore", action: () => createWindow('file-explorer') },
                        { label: "New Folder", icon: "fa-folder-plus", action: (winEl) => showTemporaryMessage("New Folder (from menu)", 1500) },
                        { isDivider: true },
                        { label: "Close Window", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) }
                    ]},
                    { label: "Edit", items: [
                        { label: "Cut", icon: "fa-cut", action: () => showTemporaryMessage("Cut (mock)", 1500) },
                        { label: "Copy", icon: "fa-copy", action: () => showTemporaryMessage("Copy (mock)", 1500) },
                        { label: "Paste", icon: "fa-paste", action: () => showTemporaryMessage("Paste (mock)", 1500) },
                    ]},
                    { label: "View", items: [
                        { label: "Sort By...", icon: "fa-sort-amount-down", action: () => showTemporaryMessage("Sort options (mock)", 1500) },
                    ]},
                    { label: "Help", items: [{ label: "About Files", action: () => showTemporaryMessage("OSWeb Files v1.0", 1500) }] }
                ],
                contextMenuItems: [{label: "New Folder", icon: "fa-folder-plus", action:()=>showTemporaryMessage("New Folder created (mock)",1500)}, {label: "Sort By...", icon: "fa-sort-amount-down", action:()=>showTemporaryMessage("Sort options (mock)",1500)}, {label: "Properties", icon:"fa-info-circle", action:()=>showTemporaryMessage("Properties (mock)", 1500)}] 
            },
            "terminal": { 
                name: "Terminal", icon: "fas fa-terminal", 
                content: `<div class="terminal-content p-1 flex-grow flex flex-col h-full"><div class="terminal-output flex-grow overflow-y-auto p-2 text-xs leading-normal"></div><div class="flex items-center p-1 border-t border-[var(--border-color)]"><span class="terminal-prompt-span text-[var(--secondary-accent)] font-mono mr-1">user@osweb:~$</span><input type="text" class="terminal-input flex-grow bg-transparent outline-none text-[var(--text-primary)] text-xs"></div></div>`, 
                allowMultiple: true, 
                isPinnedToDock: true,
                initFunction: initTerminal,
                menuBar: [
                     { label: "Shell", items: [
                        { label: "New Window", icon: "fa-window-restore", action: () => createWindow('terminal') },
                        { label: "New Tab (mock)", icon: "fa-plus-square", action: () => showTemporaryMessage("New Terminal Tab (mock)", 1500) },
                        { isDivider: true },
                        { label: "Clear Scrollback", icon: "fa-eraser", action: (winEl) => mockTerminalAction("Clear Scrollback", winEl) },
                        { label: "Close Window", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) }
                    ]},
                    { label: "Edit", items: [
                        { label: "Copy", icon: "fa-copy", action: (winEl) => mockTerminalAction("Copy", winEl) },
                        { label: "Paste", icon: "fa-paste", action: (winEl) => mockTerminalAction("Paste", winEl) },
                    ]},
                    { label: "Help", items: [{ label: "About Terminal", action: () => showTemporaryMessage("OSWeb Terminal v1.1", 1500) }] }
                ],
                contextMenuItems: [{label:"Copy", icon:"fa-copy", action:(winEl)=>mockTerminalAction("Copy", winEl)}, {label:"Paste", icon:"fa-paste", action:(winEl)=>mockTerminalAction("Paste", winEl)}, {label:"Clear", icon:"fa-eraser", action:(winEl)=>mockTerminalAction("Clear", winEl)}, {isDivider: true}, {label:"✨ Explain Last Cmd", icon:"fa-question-circle", action:(winEl)=>handleTerminalExplain(winEl)}] 
            },
            "web-browser": { 
                name: "OSWeb Browser", icon: "fas fa-globe-americas", 
                content: `<div class="h-full flex flex-col"><div class="p-2 bg-[var(--surface-overlay-bg)] border-b border-[var(--border-color)] flex items-center space-x-2"><i id="browser-lock-icon" class="fas fa-info-circle px-1 text-[var(--icon-color)]"></i><input type="text" id="browser-address-bar" class="flex-grow bg-[var(--surface-bg)] border border-[var(--border-color)] rounded-full px-3 py-1 text-xs outline-none focus:ring-1 focus:ring-[var(--accent-color)] focus:border-[var(--accent-color)]" value="" placeholder="Type URL and press Enter"><button id="browser-go-button" class="p-1.5 rounded-full hover:bg-[var(--surface-active-bg)]" title="Go"><i class="fas fa-arrow-right text-xs"></i></button></div><iframe id="browser-content-frame" src="about:blank" title="Browser Content" class="w-full flex-grow border-0" sandbox="allow-scripts allow-same-origin allow-popups allow-forms"></iframe></div>`, 
                allowMultiple: true, 
                isPinnedToDock: true,
                initFunction: (winEl, data) => initWebBrowser(winEl, data?.url),
                menuBar: [
                    { label: "File", items: [
                        { label: "New Tab (mock)", icon: "fa-plus-square", action: (winEl) => showTemporaryMessage("New Tab (mock from menu)",1500) },
                        { label: "New Window", icon: "fa-window-restore", action: () => createWindow('web-browser') },
                        { isDivider: true },
                        { label: "Close Tab (mock)", icon: "fa-times-circle", action: (winEl) => showTemporaryMessage("Close Tab (mock from menu)",1500) },
                        { label: "Close Window", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) }
                    ]},
                    { label: "Edit", items: [
                        { label: "Cut", icon: "fa-cut", action: () => showTemporaryMessage("Cut (mock)", 1500) },
                        { label: "Copy", icon: "fa-copy", action: () => showTemporaryMessage("Copy (mock)", 1500) },
                        { label: "Paste", icon: "fa-paste", action: () => showTemporaryMessage("Paste (mock)", 1500) },
                    ]},
                    { label: "View", items: [
                        { label: "Reload Page", icon: "fa-sync", action: (winEl) => { showTemporaryMessage("Reload only affects internal placeholder.", 2000); const frame = winEl ? winEl.querySelector('#browser-content-frame') : null; if (frame && frame.src !== 'about:blank' && frame.src.startsWith('data:text/html')) { try { frame.src = frame.src; } catch(e){ console.error("Reload error:", e); }} } },
                        { label: "Zoom In", icon: "fa-search-plus", action: () => showTemporaryMessage("Zoom In (mock)", 1500) },
                        { label: "Zoom Out", icon: "fa-search-minus", action: () => showTemporaryMessage("Zoom Out (mock)", 1500) },
                    ]},
                    { label: "Bookmarks", items: [
                        { label: "Show All Bookmarks", icon: "fa-book", action: () => showTemporaryMessage("Showing bookmarks (mock)", 1500) },
                        { label: "Add Bookmark", icon: "fa-bookmark", action: (winEl) => showTemporaryMessage("Bookmark Added (mock)",1500) },
                    ]},
                    { label: "Help", items: [{ label: "About OSWeb Browser", action: () => showTemporaryMessage("OSWeb Browser v1.0", 1500) }] }
                ],
                contextMenuItems: [{label:"New Tab (mock)", icon:"fa-plus-square", action:()=>showTemporaryMessage("New Tab (mock)",1500)}, {label:"Reload Page", icon:"fa-sync", action:(winEl) => { showTemporaryMessage("Reload only affects internal placeholder.", 2000); const frame = winEl ? winEl.querySelector('#browser-content-frame') : null; if (frame && frame.src !== 'about:blank' && frame.src.startsWith('data:text/html')) try { frame.src = frame.src; } catch(e){ console.error("Reload error:", e); }} }, {label:"Add Bookmark", icon:"fa-bookmark", action:()=>showTemporaryMessage("Bookmark Added (mock)",1500)}] 
            },
            "notepad": { 
                name: "Notes", icon: "fas fa-sticky-note", 
                content: `<div class="notepad-content flex-grow flex flex-col h-full"><textarea class="w-full flex-grow p-4 text-sm border-0 outline-none resize-none" placeholder="Start typing your note..."></textarea><div class="notepad-toolbar flex items-center justify-end space-x-2 p-2"><button class="notepad-action-button" id="summarize-note-btn">✨ Summarize</button><button class="notepad-action-button" id="suggest-title-btn">✨ Suggest Title</button></div></div>`, 
                allowMultiple: true, 
                isPinnedToDock: true,
                initFunction: initNotepad,
                menuBar: [
                    { label: "File", items: [
                        { label: "New Note", icon: "fa-plus", action: () => createWindow('notepad') },
                        { label: "Save Note", icon: "fa-save", action: (winEl) => showTemporaryMessage("Note Saved (mock)",1500) },
                        { isDivider: true },
                        { label: "Close Window", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) }
                    ]},
                    { label: "Edit", items: [
                        { label: "✨ Summarize Note", icon:"fa-bolt", action:(winEl)=>handleNotepadSummarize(winEl || (activeWindowId ? openWindows[activeWindowId].element : null))},
                        { label: "✨ Suggest Title", icon:"fa-lightbulb", action:(winEl)=>handleNotepadSuggestTitle(winEl || (activeWindowId ? openWindows[activeWindowId].element : null))},
                    ]},
                    { label: "Help", items: [{ label: "About Notes", action: () => showTemporaryMessage("OSWeb Notes v1.0", 1500) }] }
                ],
                contextMenuItems: [{label:"New Note", icon:"fa-plus", action:()=>createWindow('notepad')}, {label:"Save Note", icon:"fa-save", action:()=>showTemporaryMessage("Note Saved (mock)",1500)}, {isDivider: true}, {label:"✨ Summarize Note", icon:"fa-bolt", action:(winEl)=>handleNotepadSummarize(winEl)}, {label:"✨ Suggest Title", icon:"fa-lightbulb", action:(winEl)=>handleNotepadSuggestTitle(winEl)}] 
            },
            "calculator": { 
                name: "Calculator", icon: "fas fa-calculator", 
                content: `<div class="p-4 flex flex-col h-full"><div id="calc-output" class="calc-display">0</div><div class="calculator-grid flex-grow"> <button class="calc-button" data-value="7">7</button> <button class="calc-button" data-value="8">8</button> <button class="calc-button" data-value="9">9</button> <button class="calc-button operator" data-op="/">÷</button> <button class="calc-button" data-value="4">4</button> <button class="calc-button" data-value="5">5</button> <button class="calc-button" data-value="6">6</button> <button class="calc-button operator" data-op="*">×</button> <button class="calc-button" data-value="1">1</button> <button class="calc-button" data-value="2">2</button> <button class="calc-button" data-value="3">3</button> <button class="calc-button operator" data-op="-">-</button> <button class="calc-button" data-value="0">0</button> <button class="calc-button" data-value=".">.</button> <button class="calc-button operator" data-op="C">C</button> <button class="calc-button operator" data-op="+">+</button> <button class="calc-button equals col-span-4" data-op="=">=</button> </div></div>`, 
                allowMultiple: false, 
                isPinnedToDock: false, 
                initFunction: initCalculator,
                menuBar: [
                    { label: "View", items: [{ label: "Standard", icon: "fa-calculator", action: () => showTemporaryMessage("Standard mode (already active)", 1000)}, { label: "Scientific (mock)", icon: "fa-flask", action: () => showTemporaryMessage("Scientific mode (mock)", 1500)}] },
                    { label: "Edit", items: [{ label: "Copy", icon: "fa-copy", action: (winEl) => { const res = winEl.querySelector('#calc-output').textContent; try { navigator.clipboard.writeText(res).then(() => showTemporaryMessage(`Copied: ${res}`, 1500)).catch(() => { const textArea = document.createElement("textarea"); textArea.value = res; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage(`Copied (fallback): ${res}`, 1500); }); } catch (err) { const textArea = document.createElement("textarea"); textArea.value = res; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage(`Copied (fallback): ${res}`, 1500); } }}]},
                    { label: "Help", items: [{ label: "About Calculator", action: () => showTemporaryMessage("OSWeb Calculator v1.0", 1500) }] }
                ],
                contextMenuItems:[{label: "Copy Result", icon:"fa-copy", action:(winEl)=>{ const res = winEl.querySelector('#calc-output').textContent; try { navigator.clipboard.writeText(res).then(() => showTemporaryMessage(`Copied: ${res}`, 1500)).catch(() => { const textArea = document.createElement("textarea"); textArea.value = res; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage(`Copied (fallback): ${res}`, 1500); }); } catch (err) { const textArea = document.createElement("textarea"); textArea.value = res; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage(`Copied (fallback): ${res}`, 1500); } }}]
            },
            "settings": { 
                name: "Settings", icon: "fas fa-cog", 
                content: `<div class="settings-grid h-full">
                            <div class="settings-sidebar">
                                <div class="settings-sidebar-item active" data-pane="settings-appearance"><i class="fas fa-palette fa-fw mr-2"></i>Appearance</div>
                                <div class="settings-sidebar-item" data-pane="settings-network"><i class="fas fa-wifi fa-fw mr-2"></i>Network</div>
                                <div class="settings-sidebar-item" data-pane="settings-system"><i class="fas fa-cogs fa-fw mr-2"></i>System</div>
                                <div class="settings-sidebar-item" data-pane="settings-apps"><i class="fas fa-th-large fa-fw mr-2"></i>Applications</div>
                            </div>
                            <div class="settings-content-pane">
                                <div id="settings-appearance">
                                    <h3>Appearance</h3>
                                    <div class="settings-item">
                                        <label for="settings-theme-selector">Theme</label>
                                        <select id="settings-theme-selector"></select>
                                    </div>
                                    <div class="settings-item">
                                        <label for="settings-wallpaper-changer">Wallpaper (Cycles next)</label>
                                        <button class="action-button" id="settings-wallpaper-changer" onclick="changeWallpaperContext(false); showTemporaryMessage('Wallpaper Changed',1000);">Change Wallpaper</button>
                                    </div>
                                     <div class="settings-item">
                                        <label for="settings-dock-transparency">Dock Transparency: <span id="settings-dock-label"></span></label>
                                        <input type="range" id="settings-dock-transparency" min="0" max="3" value="${currentDockTransparencyIndex}" oninput="currentDockTransparencyIndex = this.value; applyDockTransparency(); document.getElementById('settings-dock-label').textContent = dockTransparencyLevels[this.value].label;">
                                    </div>
                                     <div class="settings-item">
                                        <label for="settings-window-transparency">Window Transparency: <span id="settings-window-label"></span></label>
                                        <input type="range" id="settings-window-transparency" min="0" max="4" value="${currentWindowTransparencyIndex}" oninput="currentWindowTransparencyIndex = this.value; applyWindowTransparency(); document.getElementById('settings-window-label').textContent = windowTransparencyLevels[this.value].label;">
                                    </div>
                                </div>
                                <div id="settings-network" class="hidden">
                                    <h3>Network & Internet</h3>
                                    <p class="text-sm text-[var(--text-secondary)]">Mock network settings. Wi-Fi: Connected (Strong Signal). Ethernet: Not Connected.</p>
                                </div>
                                <div id="settings-system" class="hidden">
                                    <h3>System Information</h3>
                                    <p class="text-sm text-[var(--text-secondary)]">OS Version: ${OS_VERSION}<br>User: ${currentUsername || 'user'}<br>Mock Hardware Info: CPU X-Core, 8GB RAM</p>
                                </div>
                                <div id="settings-apps" class="hidden">
                                    <h3>Applications</h3>
                                    <p class="text-sm text-[var(--text-secondary)]">Manage installed applications (mock).</p>
                                </div>
                            </div>
                         </div>`, 
                allowMultiple: false, 
                isPinnedToDock: true,
                initialWidth: 700, initialHeight: 500,
                initFunction: initSettingsApp,
                menuBar: [
                    { label: "File", items: [{ label: "Close Settings", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : null }] },
                    { label: "Help", items: [{ label: "About Settings", action: () => showTemporaryMessage("OSWeb Settings v1.1", 1500) }] }
                ]
            },
            "ai-assistant": { 
                name: "Assistant", icon: "fas fa-robot", 
                content: `<div class="p-4 flex flex-col h-full"><div class="flex-grow bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] rounded-md p-2 overflow-y-auto text-xs mb-2" id="ai-chat-log"></div><input type="text" id="ai-command-input" placeholder="Ask Assistant..." class="p-2.5 rounded-md bg-[var(--surface-overlay-bg)] border border-[var(--border-color)] outline-none focus:border-[var(--accent-color)] focus:ring-1 focus:ring-[var(--accent-color)] text-sm"></div>`, 
                allowMultiple: false, 
                isPinnedToDock: false,
                initFunction: initAIAssistant,
                menuBar: [
                    { label: "Chat", items: [{ label: "Clear History", icon: "fa-trash-alt", action: (winEl) => { winEl.querySelector('#ai-chat-log').innerHTML = ''; showTemporaryMessage("Chat history cleared.",1500); }}]},
                    { label: "Help", items: [{ label: "About Assistant", action: () => showTemporaryMessage("OSWeb AI Assistant v1.0", 1500) }] }
                ],
                contextMenuItems:[{label: "Clear Chat History", icon:"fa-trash-alt", action:(winEl)=>{ winEl.querySelector('#ai-chat-log').innerHTML = ''; showTemporaryMessage("Chat history cleared.",1500);}}, {label:"Copy Last Response", icon:"fa-copy", action:(winEl)=> { const logs = winEl.querySelectorAll('#ai-chat-log > div > span'); if(logs.length > 0){ const lastResponse = logs[logs.length-1].textContent; try { navigator.clipboard.writeText(lastResponse).then(() => showTemporaryMessage("Copied last response.",1500)).catch(() => { const textArea = document.createElement("textarea"); textArea.value = lastResponse; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage("Copied last response (fallback).",1500); }); } catch (err) { const textArea = document.createElement("textarea"); textArea.value = lastResponse; document.body.appendChild(textArea); textArea.select(); document.execCommand('copy'); textArea.remove(); showTemporaryMessage("Copied last response (fallback).",1500); }} else {showTemporaryMessage("No response to copy.",1500);}}}]
            },
            "mail-client": { 
                name: "Mail", icon: "fas fa-envelope", 
                content: `<div class="mail-grid"><div class="mail-sidebar"><div class="mail-sidebar-item active" onclick="selectMailFolder(this, 'Inbox')"><i class="fas fa-inbox mr-2 w-4"></i>Inbox <span class="text-xs ml-auto bg-[var(--accent-color)] text-[var(--primary-bg)] px-1.5 py-0.5 rounded-full">3</span></div><div class="mail-sidebar-item" onclick="selectMailFolder(this, 'Sent')"><i class="fas fa-paper-plane mr-2 w-4"></i>Sent</div><div class="mail-sidebar-item" onclick="selectMailFolder(this, 'Drafts')"><i class="fas fa-file-alt mr-2 w-4"></i>Drafts</div><div class="mail-sidebar-item" onclick="selectMailFolder(this, 'Archive')"><i class="fas fa-archive mr-2 w-4"></i>Archive</div><div class="mail-sidebar-item" onclick="selectMailFolder(this, 'Spam')"><i class="fas fa-exclamation-triangle mr-2 w-4"></i>Spam</div></div><div class="mail-content"><div class="mail-message-list flex-shrink-0 h-1/3 overflow-y-auto mb-2 border-b border-[var(--border-color)]"><div class="mail-message-list-item" onclick="showMailPreview(this.closest('.window'), 'Update', 'System update available...')"><strong>System Update</strong> - Your OS needs an update...</div><div class="mail-message-list-item" onclick="showMailPreview(this.closest('.window'),'Meeting', 'Project discussion at 3 PM...')"><strong>Project Meeting</strong> - Discussion about project...</div><div class="mail-message-list-item" onclick="showMailPreview(this.closest('.window'),'Newsletter', 'Weekly tech news...')"><strong>Tech Newsletter</strong> - Latest in tech...</div></div><div class="mail-message-preview"><h3 id="mail-preview-subject" class="text-lg font-medium mb-1">Select a message</h3><p id="mail-preview-body" class="text-xs text-[var(--text-secondary)]">Message content will appear here.</p></div></div></div>`, 
                allowMultiple: false, 
                isPinnedToDock: true,
                initFunction: initMailClient,
                menuBar: [
                    { label: "File", items: [{ label: "Compose New Mail", icon: "fa-pen-nib", action: () => showTemporaryMessage("Opening compose window (mock)...", 1500)}, {isDivider: true}, { label: "Close", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : null }] },
                    { label: "Edit", items: [{ label: "Preferences (mock)", icon: "fa-sliders-h", action: () => showTemporaryMessage("Mail Preferences (mock)", 1500)}] },
                    { label: "View", items: [{ label: "Refresh Mailbox", icon: "fa-sync", action: () => showTemporaryMessage("Checking for new mail (mock)...",1500)}] }
                ],
                contextMenuItems:[{label:"Compose New Mail", icon:"fa-pen-nib", action:()=>showTemporaryMessage("Opening compose window (mock)...", 1500)}, {label:"Refresh Mailbox", icon:"fa-sync", action:()=>showTemporaryMessage("Checking for new mail (mock)...",1500)}, {label:"Archive Selected", icon:"fa-archive", action:()=>showTemporaryMessage("Archived (mock).",1500)}]
            },
            "music-player": { 
                name: "Music", icon: "fas fa-music", 
                content: `<div class="music-player-content"><div class="music-track-info"><img src="https://placehold.co/128x128/2A2A2A/82AAFF?text=AlbumArt&font=roboto" alt="Album Art"><h3 class="text-lg font-medium" id="music-track-title">Future Beats</h3><p class="text-sm text-[var(--text-secondary)]" id="music-track-artist">Synthwave Artist</p></div><div class="music-controls"><button class="top-panel-item p-3 rounded-full text-xl"><i class="fas fa-step-backward"></i></button><button class="top-panel-item p-4 rounded-full text-2xl bg-[var(--accent-color)] !text-[var(--primary-bg)]"><i class="fas fa-play"></i></button><button class="top-panel-item p-3 rounded-full text-xl"><i class="fas fa-step-forward"></i></button></div><div class="music-playlist"><div class="music-playlist-item">Track 1 - Electro Funk</div><div class="music-playlist-item">Track 2 - Neon Drive</div><div class="music-playlist-item">Track 3 - Midnight Run</div></div></div>`, 
                allowMultiple: false, 
                isPinnedToDock: true,
                menuBar: [
                    { label: "Playback", items: [{ label: "Play/Pause", icon: "fa-play-circle", action: () => showTemporaryMessage("Toggled Play/Pause (mock)",1000)}, { label: "Next Track", icon: "fa-step-forward", action: () => showTemporaryMessage("Next Track (mock)",1000)}, { label: "Previous Track", icon: "fa-step-backward", action: () => showTemporaryMessage("Previous Track (mock)",1000)} ]},
                    { label: "File", items: [{ label: "Add Music (mock)", icon: "fa-plus", action: () => showTemporaryMessage("Add music (mock)",1500)}]}
                ],
                contextMenuItems:[{label:"Play/Pause", icon:"fa-play-circle", action:()=>showTemporaryMessage("Toggled Play/Pause (mock)",1000)}, {label:"Next Track", icon:"fa-step-forward", action:()=>showTemporaryMessage("Next Track (mock)",1000)},{label:"Add to Queue", icon:"fa-plus", action:()=>showTemporaryMessage("Added to queue (mock)",1000)}]
            },
            "image-viewer": {
                name: "Image Viewer", icon: "fas fa-image",
                content: `<div class="p-2 flex flex-col items-center justify-center h-full bg-black/50"><img id="image-viewer-img" src="https://placehold.co/300x200/44475a/E0E0E0?text=No+Image+Loaded&font=roboto" alt="Loaded Image" class="max-w-full max-h-[80%] object-contain rounded shadow-lg"><div class="mt-3 flex space-x-2"><button class="action-button text-xs !px-3 !py-1.5" onclick="showTemporaryMessage('Mock: Previous Image', 1000)"><i class="fas fa-arrow-left mr-1"></i> Prev</button><button class="action-button text-xs !px-3 !py-1.5" onclick="showTemporaryMessage('Mock: Next Image', 1000)">Next <i class="fas fa-arrow-right ml-1"></i></button><button class="action-button text-xs !px-3 !py-1.5" onclick="showTemporaryMessage('Mock: Zoom In', 1000)"><i class="fas fa-search-plus"></i></button></div><p class="text-xs text-[var(--text-secondary)] mt-2">Right-click for more options.</p></div>`,
                allowMultiple: true, initialWidth: 450, initialHeight: 350, isPinnedToDock: false,
                menuBar: [ { label: "File", items: [ { label: "Open Image (mock)", icon: "fa-folder-open", action: () => showTemporaryMessage("Open Image (mock)", 1500) }, { isDivider: true }, { label: "Close", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) } ]}, { label: "View", items: [ { label: "Zoom In (mock)", icon: "fa-search-plus", action: () => showTemporaryMessage("Zoom In (mock)", 1500) }, { label: "Zoom Out (mock)", icon: "fa-search-minus", action: () => showTemporaryMessage("Zoom Out (mock)", 1500) }, { label: "Actual Size (mock)", icon: "fa-compress-arrows-alt", action: () => showTemporaryMessage("Actual Size (mock)", 1500) }, ]} ],
                contextMenuItems: [ {label: "Open Image (mock)", icon:"fa-folder-open", action:()=>showTemporaryMessage("Open Image (mock)",1500)}, {label: "Copy Image (mock)", icon:"fa-copy", action:()=>showTemporaryMessage("Copy Image (mock)",1500)}, {isDivider: true}, {label: "Zoom In (mock)", icon:"fa-search-plus", action:()=>showTemporaryMessage("Zoom In (mock)",1500)}, {label: "Properties (mock)", icon:"fa-info-circle", action:()=>showTemporaryMessage("Image Properties (mock)",1500)} ]
            },
            "weather-app": {
                name: "Weather", icon: "fas fa-cloud-sun",
                content: `<div class="p-4 flex flex-col items-center justify-center h-full text-center"><i class="fas fa-cloud-sun text-6xl text-yellow-400 mb-3"></i><h3 id="weather-city" class="text-2xl font-medium">Seaford, NY</h3><p id="weather-temp" class="text-5xl font-bold my-1">72°F</p><p id="weather-condition" class="text-lg text-[var(--text-secondary)]">Partly Cloudy</p><p class="text-xs text-[var(--text-secondary)] mt-3">Humidity: 60% | Wind: 5mph</p><button class="action-button mt-4 text-sm" onclick="showTemporaryMessage('Refreshing weather (mock)...', 1500)"><i class="fas fa-sync-alt mr-1.5"></i> Refresh</button></div>`,
                allowMultiple: false, initialWidth: 320, initialHeight: 380, isPinnedToDock: false,
                menuBar: [ { label: "File", items: [ { label: "Refresh Data", icon: "fa-sync-alt", action: () => showTemporaryMessage("Refreshing weather (mock)...", 1500) }, { label: "Change Location (mock)", icon: "fa-map-marker-alt", action: () => showTemporaryMessage("Change Location (mock)", 1500) }, { isDivider: true }, { label: "Close", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) } ]}, { label: "Help", items: [{ label: "About Weather", action: () => showTemporaryMessage("OSWeb Weather v1.0 (Mock Data)", 1500) }] } ],
                contextMenuItems: [ {label: "Refresh Data", icon:"fa-sync-alt", action:()=>showTemporaryMessage("Refreshing weather (mock)...",1500)}, {label: "Change Location (mock)", icon:"fa-map-marker-alt", action:()=>showTemporaryMessage("Change Location (mock)",1500)}, {label: "View Details (mock)", icon:"fa-info-circle", action:()=>showTemporaryMessage("Detailed forecast (mock)",1500)} ]
            },
            "clicker-game": {
                name: "Clicker Game", icon: "fas fa-mouse-pointer",
                content: `<div class="p-4 flex flex-col items-center justify-center h-full text-center"><h3 class="text-xl font-medium mb-2">Score: <span id="clicker-score">0</span></h3><button id="clicker-button" class="action-button text-lg px-8 py-4 my-4 !bg-[var(--secondary-accent)] hover:!bg-[color-mix(in_srgb,_var(--secondary-accent)_90%,_white)] active:transform active:scale-95 transition-transform">Click Me!</button><p class="text-xs text-[var(--text-secondary)]">How high can you score?</p></div>`,
                allowMultiple: false, initialWidth: 300, initialHeight: 250, isPinnedToDock: false,
                initFunction: initClickerGame,
                menuBar: [ { label: "Game", items: [ { label: "Reset Score", icon: "fa-undo", action: (winEl) => { if(winEl) { const scoreEl = winEl.querySelector('#clicker-score'); if(scoreEl) scoreEl.textContent = '0'; const btn = winEl.querySelector('#clicker-button'); if(btn) btn.dataset.score = '0'; } showTemporaryMessage("Score Reset!", 1000); } }, { isDivider: true }, { label: "Close", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) } ]}, { label: "Help", items: [{ label: "About Clicker", action: () => showTemporaryMessage("OSWeb Clicker Game v1.0", 1500) }] } ],
                contextMenuItems: [ {label: "Reset Score", icon:"fa-undo", action:(winEl) => { if(winEl) { const scoreEl = winEl.querySelector('#clicker-score'); if(scoreEl) scoreEl.textContent = '0'; const btn = winEl.querySelector('#clicker-button'); if(btn) btn.dataset.score = '0'; } showTemporaryMessage("Score Reset!", 1000); }}, {label: "View High Scores (mock)", icon:"fa-trophy", action:()=>showTemporaryMessage("High Scores (mock)",1500)} ]
            },
            "system-monitor": {
                name: "System Monitor", icon: "fas fa-chart-line",
                content: `<div class="p-4 space-y-3 text-sm overflow-y-auto h-full"><div class="mb-2"><h3 class="font-medium mb-1">CPU Usage</h3><div class="w-full bg-[var(--surface-overlay-bg)] rounded-full h-5"><div id="sysmon-cpu-bar" class="bg-[var(--accent-color)] h-5 rounded-full text-xs text-white text-center leading-5" style="width: 30%;">30%</div></div></div><div class="mb-2"><h3 class="font-medium mb-1">Memory Usage</h3><div class="w-full bg-[var(--surface-overlay-bg)] rounded-full h-5"><div id="sysmon-mem-bar" class="bg-[var(--secondary-accent)] h-5 rounded-full text-xs text-black text-center leading-5" style="width: 55%;">4.4/8.0 GB</div></div></div><div class="mb-2"><h3 class="font-medium mb-1">Disk I/O (mock)</h3><p class="text-[var(--text-secondary)]">Read: 1.2 MB/s, Write: 300 KB/s</p></div><div class="mb-2"><h3 class="font-medium mb-1">Network Activity (mock)</h3><p class="text-[var(--text-secondary)]">Down: 5.6 Mbps, Up: 1.1 Mbps</p></div><button class="action-button text-xs mt-2" onclick="if(activeWindowId && openWindows[activeWindowId] && openWindows[activeWindowId].appId === 'system-monitor' && typeof initSystemMonitor === 'function') initSystemMonitor(openWindows[activeWindowId].element, true); showTemporaryMessage('Refreshing monitor data (mock)...', 1000);"><i class="fas fa-sync-alt mr-1"></i> Refresh</button></div>`,
                allowMultiple: false, initialWidth: 380, initialHeight: 320, isPinnedToDock: false,
                initFunction: initSystemMonitor,
                menuBar: [ { label: "File", items: [ { label: "Refresh Data", icon: "fa-sync-alt", action: (winEl) => { if(winEl && typeof initSystemMonitor === 'function') initSystemMonitor(winEl, true); showTemporaryMessage("Refreshing monitor data (mock)...", 1000); } }, { isDivider: true }, { label: "Close", icon: "fa-times", action: (winEl) => winEl ? closeWindow(winEl.id) : (activeWindowId ? closeWindow(activeWindowId) : null) } ]}, { label: "View", items: [{ label: "Processes (mock)", icon: "fa-list-ul", action: () => showTemporaryMessage("Viewing processes (mock)", 1500) }] } ],
                contextMenuItems: [ {label: "Refresh Data", icon:"fa-sync-alt", action:(winEl) => { if(winEl && typeof initSystemMonitor === 'function') initSystemMonitor(winEl, true); showTemporaryMessage("Refreshing monitor data (mock)...", 1000); }}, {label: "View Processes (mock)", icon:"fa-list-ul", action:()=>showTemporaryMessage("Viewing processes (mock)",1500)}, {label: "Resource History (mock)", icon:"fa-chart-area", action:()=>showTemporaryMessage("Resource history (mock)",1500)} ]
            },
            "code-studio": {
                name: "Code Studio", icon: "fas fa-code-branch",
                content: `<div class="flex flex-col h-full">
                            <div class="p-1.5 bg-[var(--surface-overlay-bg)] border-b border-[var(--border-color)] text-xs flex items-center space-x-2">
                                <button class="top-panel-item !p-1" title="New File"><i class="fas fa-file"></i></button>
                                <button class="top-panel-item !p-1" title="Open File"><i class="fas fa-folder-open"></i></button>
                                <button class="top-panel-item !p-1" title="Save File"><i class="fas fa-save"></i></button>
                                <span class="text-[var(--text-secondary)]">Untitled.js</span>
                            </div>
                            <textarea class="w-full flex-grow p-3 text-sm font-mono bg-[var(--primary-bg)] text-[var(--text-primary)] border-0 outline-none resize-none" spellcheck="false" placeholder="// Start coding your masterpiece..."></textarea>
                            <div class="p-1.5 bg-[var(--surface-overlay-bg)] border-t border-[var(--border-color)] text-xs text-[var(--text-secondary)]">Ln 1, Col 1 (UTF-8) JavaScript (Mock)</div>
                         </div>`,
                allowMultiple: true, initialWidth: 700, initialHeight: 500, isPinnedToDock: true,
                menuBar: [
                    { label: "File", items: [{label:"New"}, {label:"Open"}, {label:"Save"}, {label:"Save As..."}, {isDivider:true}, {label:"Close"}] },
                    { label: "Edit", items: [{label:"Undo"}, {label:"Redo"}, {isDivider:true}, {label:"Cut"}, {label:"Copy"}, {label:"Paste"}] },
                    { label: "View", items: [{label:"Command Palette..."}, {label:"Toggle Sidebar (mock)"}] },
                    { label: "Terminal", items: [{label:"New Terminal (mock)"}] }
                ],
                contextMenuItems: [{label:"Save File"}, {label:"Format Document (mock)"}]
            },
            "pdf-viewer": {
                name: "PDF Viewer", icon: "fas fa-file-pdf",
                content: `<div class="p-4 flex flex-col items-center justify-center h-full bg-gray-700 text-white">
                            <i class="fas fa-file-pdf text-6xl mb-4 text-red-400"></i>
                            <p class="text-lg">PDF Viewer (Mock)</p>
                            <p class="text-sm">No PDF loaded. Use File > Open to load a PDF (mock).</p>
                         </div>`,
                allowMultiple: true, initialWidth: 600, initialHeight: 700, isPinnedToDock: false,
                menuBar: [
                    { label: "File", items: [{label:"Open PDF (mock)"}, {isDivider:true}, {label:"Close"}] },
                    { label: "View", items: [{label:"Zoom In"}, {label:"Zoom Out"}, {label:"Fit to Page"}] }
                ]
            },
            "calendar-app": {
                name: "Calendar", icon: "fas fa-calendar-alt",
                content: `<div class="p-3 flex flex-col h-full">
                            <div class="flex justify-between items-center mb-3">
                                <button class="calendar-app-prev top-panel-item p-2 rounded-full"><i class="fas fa-chevron-left"></i></button>
                                <h2 class="calendar-app-month-year text-xl font-medium text-[var(--text-primary)]">Month Year</h2>
                                <button class="calendar-app-next top-panel-item p-2 rounded-full"><i class="fas fa-chevron-right"></i></button>
                                <button class="calendar-app-today action-button !text-xs !py-1 !px-2 ml-2">Today</button>
                            </div>
                            <div class="calendar-app-days-grid grid grid-cols-7 gap-px bg-[var(--border-color)] border border-[var(--border-color)] flex-grow overflow-y-auto">
                                <!-- Days will be populated by JS -->
                            </div>
                          </div>`,
                allowMultiple: false, initialWidth: 750, initialHeight: 550, isPinnedToDock: true,
                initFunction: initCalendarApp,
                menuBar: [
                    { label: "File", items: [{label:"New Event (mock)"}, {isDivider:true}, {label:"Close"}] },
                    { label: "View", items: [{label:"Day"}, {label:"Week"}, {label:"Month"}] }
                ]
            },
            "task-manager": {
                name: "Task Manager", icon: "fas fa-tasks",
                content: `<div class="p-2 flex flex-col h-full">
                            <div class="overflow-x-auto flex-grow">
                                <table class="min-w-full text-xs text-left">
                                    <thead class="border-b border-[var(--border-color)]">
                                        <tr><th class="p-1.5">Process Name</th><th class="p-1.5">CPU%</th><th class="p-1.5">Memory</th><th class="p-1.5">PID</th></tr>
                                    </thead>
                                    <tbody class="divide-y divide-[var(--border-color)]">
                                        <tr><td class="p-1.5">OSWeb Shell</td><td class="p-1.5">2.5</td><td class="p-1.5">120MB</td><td class="p-1.5">101</td></tr>
                                        <tr><td class="p-1.5">Browser</td><td class="p-1.5">15.2</td><td class="p-1.5">350MB</td><td class="p-1.5">1052</td></tr>
                                        <tr><td class="p-1.5">Terminal</td><td class="p-1.5">0.8</td><td class="p-1.5">60MB</td><td class="p-1.5">1230</td></tr>
                                        <tr><td class="p-1.5">Music Player</td><td class="p-1.5">5.1</td><td class="p-1.5">90MB</td><td class="p-1.5">1400</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <button class="action-button text-xs mt-2 self-end" onclick="showTemporaryMessage('End Task (mock)', 1500)">End Task</button>
                         </div>`,
                allowMultiple: false, initialWidth: 500, initialHeight: 350, isPinnedToDock: false,
                menuBar: [
                    { label: "File", items: [{label:"Run New Task (mock)"}, {isDivider:true}, {label:"Close"}] },
                    { label: "Options", items: [{label:"Always on Top (mock)"}] }
                ]
            }
        };
        
        // --- DOM Element References (available after DOM loaded) ---
        let desktopArea, dock, appMenuBarContainer, globalSearchInput, tempMsgContainer, themeToggleButton, userAvatarImg, cpuMeter, gpuMeter, showDesktopButton, appLauncherButton, myFilesFolder, clockEl, sidebar, sidebarToggle, activitiesButton, vDesktopSwitcher, contextMenuEl, wallpaperContainer, loginModal, usernameInput, loginButton, topPanel, rightSidebar, osVersionInfoEl, userInfoEl, systemUptimeEl, addDesktopButtonEl;

        function assignGlobalElements() {
            desktopArea = document.getElementById('desktop-area');
            dock = document.getElementById('dock');
            appMenuBarContainer = document.getElementById('app-menu-bar-container');
            globalSearchInput = document.getElementById('global-search-input');
            tempMsgContainer = document.getElementById('temp-message-container');
            themeToggleButton = document.getElementById('theme-toggle-button');
            userAvatarImg = document.getElementById('user-avatar-img');
            cpuMeter = document.getElementById('cpu-meter');
            gpuMeter = document.getElementById('gpu-meter');
            showDesktopButton = document.getElementById('show-desktop-button');
            appLauncherButton = document.getElementById('app-launcher-button'); // New App Launcher button in top panel
            myFilesFolder = document.getElementById('my-files-folder');
            clockEl = document.getElementById('clock');
            sidebar = document.getElementById('right-sidebar');
            sidebarToggle = document.getElementById('sidebar-toggle');
            activitiesButton = document.getElementById('activities-button');
            vDesktopSwitcher = document.getElementById('virtual-desktop-switcher');
            contextMenuEl = document.getElementById('context-menu');
            wallpaperContainer = document.getElementById('wallpaper-container');
            loginModal = document.getElementById('login-modal');
            usernameInput = document.getElementById('username-input');
            loginButton = document.getElementById('login-button');
            topPanel = document.getElementById('top-panel');
            rightSidebar = document.getElementById('right-sidebar');
            osVersionInfoEl = document.getElementById('os-version-info');
            userInfoEl = document.getElementById('user-info');
            systemUptimeEl = document.getElementById('system-uptime');
            addDesktopButtonEl = document.getElementById('add-desktop-button');
        }
        
        async function callGeminiAPI(prompt, type = "text") {
            let chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
            const payload = { contents: chatHistory };
            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                if (!response.ok) { const errorData = await response.json(); console.error("Gemini API Error:", errorData); return `Error: ${errorData.error?.message || response.statusText}`; }
                const result = await response.json();
                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts && result.candidates[0].content.parts.length > 0) { return result.candidates[0].content.parts[0].text; } 
                else { console.error("Gemini API Error: Unexpected response structure", result); return "Error: Could not retrieve a valid response from the AI."; }
            } catch (error) { console.error("Fetch Error calling Gemini API:", error); return `Error: Network or fetch error. ${error.message}`; }
        }

        let tempMsgTimeout;
        function showTemporaryMessage(message, duration = 2500) { 
            clearTimeout(tempMsgTimeout); 
            if (tempMsgContainer) {
                 tempMsgContainer.textContent = message;
                 tempMsgContainer.classList.add('show');
                 tempMsgTimeout = setTimeout(() => tempMsgContainer.classList.remove('show'), duration);
            }
        }
        
        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
            if (clockEl) clockEl.textContent = timeString;
        }
        
        function updateSystemMeters() {
            if (cpuMeter) cpuMeter.textContent = `CPU: ${Math.floor(Math.random() * 70) + 5}%`;
            if (gpuMeter) gpuMeter.textContent = `GPU: ${Math.floor(Math.random() * 60) + 10}%`;
        }

        function updateSystemUptime() {
            if (!systemUptimeEl || !systemStartTime) return;
            const now = Date.now(); const diffMs = now - systemStartTime;
            const days = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diffMs % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            systemUptimeEl.textContent = `${days}d ${hours}h ${minutes}m`;
        }
        
        function updateUserAvatar() {
            if (!userAvatarImg) return;
            const avatarSrcBase = "https://placehold.co/32x32";
            const usernameInitial = currentUsername ? currentUsername.charAt(0).toUpperCase() : 'U';
            
            if (document.body.classList.contains('light-mode')) {
                userAvatarImg.src = `${avatarSrcBase}/1976D2/FFFFFF?text=${usernameInitial}&font=roboto`;
            } else if (document.body.classList.contains('indigo-magic-theme')) {
                userAvatarImg.src = `${avatarSrcBase}/88C0D0/2E3440?text=${usernameInitial}&font=roboto`;
            } else if (document.body.classList.contains('crimson-peak-theme')) {
                userAvatarImg.src = `${avatarSrcBase}/E53935/F5F5F5?text=${usernameInitial}&font=roboto`;
            } else { // Default dark mode
                userAvatarImg.src = `${avatarSrcBase}/82AAFF/1E1E1E?text=${usernameInitial}&font=roboto`;
            }
        }

        function applyDockTransparency() {
            const selectedTransparency = dockTransparencyLevels[currentDockTransparencyIndex];
            document.documentElement.style.setProperty('--dock-bg-opacity', selectedTransparency.value);
            const labelEl = document.getElementById('dock-transparency-label');
            if (labelEl) labelEl.textContent = selectedTransparency.label;
            const settingsRange = document.getElementById('settings-dock-transparency');
            if(settingsRange) settingsRange.value = currentDockTransparencyIndex;
            const settingsLabel = document.getElementById('settings-dock-label');
            if(settingsLabel) settingsLabel.textContent = selectedTransparency.label;
        }

        function toggleDockTransparency() {
            currentDockTransparencyIndex = (currentDockTransparencyIndex + 1) % dockTransparencyLevels.length;
            applyDockTransparency();
            const selectedTransparency = dockTransparencyLevels[currentDockTransparencyIndex];
            showTemporaryMessage(`Dock glass set to: ${selectedTransparency.label}`, 1500);
        }

        function applyWindowTransparency() {
            const selectedLevel = windowTransparencyLevels[currentWindowTransparencyIndex];
            const rootStyle = document.documentElement.style;
            const rgbString = getComputedStyle(document.documentElement).getPropertyValue('--surface-bg-rgb').trim();

            document.querySelectorAll('.window').forEach(win => win.classList.remove('glass-mode'));

            if (selectedLevel.value <= 0.01) { // Glass mode
                rootStyle.setProperty('--window-content-bg', 'transparent'); // Main background transparent
                document.querySelectorAll('.window:not(.minimized) .window-content-area').forEach(area => {
                    area.style.backgroundColor = `rgba(${rgbString}, ${selectedLevel.value})`; // Apply to content area for blur
                });
                document.querySelectorAll('.window:not(.minimized)').forEach(win => win.classList.add('glass-mode'));
            } else {
                if (rgbString) {
                    rootStyle.setProperty('--window-content-bg', `rgba(${rgbString}, ${selectedLevel.value})`);
                    document.querySelectorAll('.window .window-content-area').forEach(area => {
                        area.style.backgroundColor = ''; // Reset specific style if not glass
                    });
                } else {
                    console.warn("Could not get RGB values for window transparency, defaulting to solid.");
                    rootStyle.setProperty('--window-content-bg', `var(--surface-bg)`);
                }
            }
            const labelEl = document.getElementById('window-transparency-label');
            if (labelEl) labelEl.textContent = selectedLevel.label;
            const settingsRange = document.getElementById('settings-window-transparency');
            if(settingsRange) settingsRange.value = currentWindowTransparencyIndex;
            const settingsLabel = document.getElementById('settings-window-label');
            if(settingsLabel) settingsLabel.textContent = selectedLevel.label;
        }

        function toggleWindowTransparency() {
            currentWindowTransparencyIndex = (currentWindowTransparencyIndex + 1) % windowTransparencyLevels.length;
            applyWindowTransparency(); 
            const selectedLevel = windowTransparencyLevels[currentWindowTransparencyIndex];
            showTemporaryMessage(`Window glass set to: ${selectedLevel.label}`, 1500);
        }

        function createWindow(appId, initialData = {}, targetDesktopId = null) {
            const app = appConfig[appId]; if (!app) return null;
            
            const desktopToOpenOn = targetDesktopId !== null ? targetDesktopId : currentVirtualDesktop;

            if (!app.allowMultiple) {
                const existingInstanceId = Object.keys(openWindows).find(id => openWindows[id].appId === appId);
                if (existingInstanceId) {
                    const existingWindowData = openWindows[existingInstanceId];
                    if (existingWindowData.desktop !== desktopToOpenOn) {
                         moveWindowToDesktop(existingInstanceId, desktopToOpenOn, true); 
                    } else if (existingWindowData.desktop !== currentVirtualDesktop) {
                        switchVirtualDesktop(desktopToOpenOn, true); 
                    }
                    if (existingWindowData.minimized) toggleMinimizeWindow(existingInstanceId);
                    focusWindow(existingInstanceId); 
                    if (appId === 'web-browser' && initialData.url && existingWindowData.element && app.initFunction) {
                         app.initFunction(existingWindowData.element, initialData); 
                    }
                    return existingWindowData.element; 
                }
            }

            windowInstanceCounter[appId] = (windowInstanceCounter[appId] || 0) + 1;
            const instanceId = `${appId}-${windowInstanceCounter[appId]}`;
            highestZIndex++;
            const windowEl = document.createElement('div');
            windowEl.id = instanceId; 
            windowEl.className = 'window opening surface-card absolute flex flex-col overflow-hidden';
            windowEl.dataset.appId = appId;
            if (windowTransparencyLevels[currentWindowTransparencyIndex].value <= 0.01) {
                windowEl.classList.add('glass-mode');
            }


            const desktopRect = desktopArea.getBoundingClientRect();
            let initialWidth = Math.min(app.initialWidth || desktopRect.width * 0.55, desktopRect.width - 40); 
            let initialHeight = Math.min(app.initialHeight || desktopRect.height * 0.65, desktopRect.height - 40);
            // App specific size overrides
            if (appId === 'calculator') { initialWidth = 300; initialHeight = 460; }
            if (appId === 'mail-client') { initialWidth = Math.min(800, desktopRect.width - 40) ; initialHeight = Math.min(600, desktopRect.height - 40); }
            if (appId === 'music-player') { initialWidth = 360 ; initialHeight = 500; }
            if (appId === 'app-launcher') { initialWidth = 500; initialHeight = 400; }
            if (appId === 'image-viewer') { initialWidth = 450; initialHeight = 350; }
            if (appId === 'weather-app') { initialWidth = 320; initialHeight = 380; }
            if (appId === 'clicker-game') { initialWidth = 300; initialHeight = 250; }
            if (appId === 'system-monitor') { initialWidth = 380; initialHeight = 320; }
            if (appId === 'code-studio') { initialWidth = Math.min(700, desktopRect.width - 60); initialHeight = Math.min(500, desktopRect.height - 60); }
            if (appId === 'pdf-viewer') { initialWidth = Math.min(600, desktopRect.width - 60); initialHeight = Math.min(700, desktopRect.height - 60); }
            if (appId === 'calendar-app') { initialWidth = Math.min(750, desktopRect.width - 60); initialHeight = Math.min(550, desktopRect.height - 60); }
            if (appId === 'task-manager') { initialWidth = Math.min(500, desktopRect.width - 60); initialHeight = Math.min(350, desktopRect.height - 60); }


            windowEl.style.width = `${initialWidth}px`; windowEl.style.height = `${initialHeight}px`;
            const staggerOffset = (Object.values(openWindows).filter(w => w.appId === appId && w.desktop === desktopToOpenOn).length) * 25; 
            windowEl.style.top = `${Math.max(20, (desktopRect.height - initialHeight) / 2 * (0.3 + Math.random()*0.2) + staggerOffset)}px`; 
            windowEl.style.left = `${Math.max(20, (desktopRect.width - initialWidth) / 2 * (0.3 + Math.random()*0.2) + staggerOffset)}px`;
            windowEl.style.zIndex = highestZIndex;

            const resizeHandle = document.createElement('div'); resizeHandle.className = 'resize-handle';

            windowEl.innerHTML = `
                <div class="window-title-bar">
                    <div class="flex items-center"> <i class="${app.icon} app-icon text-base"></i> <span class="text-sm font-medium app-name">${app.name} ${app.allowMultiple && windowInstanceCounter[appId] > 1 ? ` (${windowInstanceCounter[appId]})` : ''}</span> </div>
                    <div class="space-x-1"> <button class="window-control p-2 rounded-full text-xs" title="Minimize" data-action="minimize"><i class="fas fa-minus"></i></button> <button class="window-control p-2 rounded-full text-xs" title="Maximize" data-action="maximize"><i class="far fa-square"></i></button> <button class="window-control p-2 rounded-full text-xs hover:!bg-[var(--error-color)] hover:!text-white" title="Close" data-action="close"><i class="fas fa-times"></i></button> </div>
                </div>
                <div class="window-content-area flex-grow overflow-hidden flex flex-col relative"> ${app.content} </div>
            `;
            windowEl.querySelector('.window-content-area').appendChild(resizeHandle);
            desktopArea.appendChild(windowEl);
            
            void windowEl.offsetWidth; windowEl.classList.remove('opening');
            showTemporaryMessage(`${app.name} initialized on Desktop ${desktopToOpenOn}.`, 1200);

            openWindows[instanceId] = { element: windowEl, name: app.name, minimized: false, originalRect: null, isMaximized: false, desktop: desktopToOpenOn, appId: appId, initialData: initialData };
            
            makeInteractive(windowEl, instanceId); 
            if (desktopToOpenOn === currentVirtualDesktop) {
                focusWindow(instanceId);
            } else {
                 windowEl.classList.add('hidden-on-desktop'); 
            }
            updateWindowVisibility(); 
            
            if (app.initFunction) {
                app.initFunction(windowEl, initialData);
            }
            initializeDock(); // Refresh dock in case this is the first instance of a non-pinned app
            return windowEl; 
        }
        
        function makeInteractive(windowEl, instanceId) {
            const titleBar = windowEl.querySelector('.window-title-bar');
            const resizeHandle = windowEl.querySelector('.resize-handle');
            const contentArea = windowEl.querySelector('.window-content-area');
            let dragInfo = { dragging: false, offsetX: 0, offsetY: 0 };
            let resizeInfo = { resizing: false, initialX: 0, initialY: 0, initialWidth: 0, initialHeight: 0 };

            const handleFocus = () => focusWindow(instanceId);
            titleBar.addEventListener('mousedown', handleFocus); titleBar.addEventListener('touchstart', handleFocus, { passive: true });
            contentArea.addEventListener('mousedown', (e) => { 
                handleFocus();
                if (activeMenuBarDropdown && !activeMenuBarDropdown.contains(e.target) && !appMenuBarContainer.contains(e.target)) {
                    closeActiveMenuBarDropdown();
                }
            }, true); 
            contentArea.addEventListener('touchstart', (e) => {
                handleFocus();
                if (activeMenuBarDropdown && !activeMenuBarDropdown.contains(e.target) && !appMenuBarContainer.contains(e.target)) {
                    closeActiveMenuBarDropdown();
                }
            }, { passive: true, capture: true });


            const startDrag = (e) => {
                if (e.target.closest('.window-control') || windowEl.classList.contains('maximized') || e.target.closest('.resize-handle')) return;
                if (e.type === 'mousedown' && e.button !== 0) return;
                e.preventDefault(); focusWindow(instanceId); dragInfo.dragging = true;
                const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
                dragInfo.offsetX = clientX - windowEl.offsetLeft; dragInfo.offsetY = clientY - windowEl.offsetTop;
                titleBar.style.cursor = 'grabbing'; document.body.style.cursor = 'grabbing';
                document.addEventListener('mousemove', onDrag); document.addEventListener('touchmove', onDrag, { passive: false });
                document.addEventListener('mouseup', stopDrag); document.addEventListener('touchend', stopDrag);
            };
            const onDrag = (e) => {
                if (!dragInfo.dragging) return; e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
                let newX = clientX - dragInfo.offsetX; let newY = clientY - dragInfo.offsetY;
                const desktopRect = desktopArea.getBoundingClientRect();
                newX = Math.max(0 - windowEl.offsetWidth + 70, Math.min(newX, desktopRect.width - 70));
                newY = Math.max(0, Math.min(newY, desktopRect.height - titleBar.offsetHeight - 20));
                windowEl.style.left = `${newX}px`; windowEl.style.top = `${newY}px`;
            };
            const stopDrag = () => {
                if (!dragInfo.dragging) return; dragInfo.dragging = false; 
                titleBar.style.cursor = 'grab'; document.body.style.cursor = 'default';
                document.removeEventListener('mousemove', onDrag); document.removeEventListener('touchmove', onDrag);
                document.removeEventListener('mouseup', stopDrag); document.removeEventListener('touchend', stopDrag);
            };
            titleBar.addEventListener('mousedown', startDrag); titleBar.addEventListener('touchstart', startDrag, { passive: false });

            const startResize = (e) => {
                e.stopPropagation(); e.preventDefault();
                if (windowEl.classList.contains('maximized')) return;
                if (e.type === 'mousedown' && e.button !== 0) return;
                focusWindow(instanceId); resizeInfo.resizing = true;
                const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
                resizeInfo.initialX = clientX; resizeInfo.initialY = clientY;
                resizeInfo.initialWidth = windowEl.offsetWidth; resizeInfo.initialHeight = windowEl.offsetHeight;
                document.body.style.cursor = 'se-resize';
                document.addEventListener('mousemove', onResize); document.addEventListener('touchmove', onResize, { passive: false });
                document.addEventListener('mouseup', stopResize); document.addEventListener('touchend', stopResize);
            };
            const onResize = (e) => {
                if (!resizeInfo.resizing) return; e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX; const clientY = e.clientY || e.touches[0].clientY;
                const dx = clientX - resizeInfo.initialX; const dy = clientY - resizeInfo.initialY;
                let newWidth = Math.max(MIN_WINDOW_WIDTH, resizeInfo.initialWidth + dx);
                let newHeight = Math.max(MIN_WINDOW_HEIGHT, resizeInfo.initialHeight + dy);
                const desktopRect = desktopArea.getBoundingClientRect(); const windowRect = windowEl.getBoundingClientRect();
                if (windowRect.left + newWidth > desktopRect.right - 10) newWidth = desktopRect.right - windowRect.left - 10;
                if (windowRect.top + newHeight > desktopRect.bottom - 10) newHeight = desktopRect.bottom - windowRect.top - 10;
                windowEl.style.width = `${newWidth}px`; windowEl.style.height = `${newHeight}px`;
            };
            const stopResize = () => {
                if (!resizeInfo.resizing) return; resizeInfo.resizing = false; document.body.style.cursor = 'default';
                document.removeEventListener('mousemove', onResize); document.removeEventListener('touchmove', onResize);
                document.removeEventListener('mouseup', stopResize); document.removeEventListener('touchend', stopResize);
            };
            resizeHandle.addEventListener('mousedown', startResize); resizeHandle.addEventListener('touchstart', startResize, { passive: false });

            windowEl.querySelector('[data-action="minimize"]').addEventListener('click', (ev) => { ev.stopPropagation(); toggleMinimizeWindow(instanceId); });
            windowEl.querySelector('[data-action="maximize"]').addEventListener('click', (ev) => { ev.stopPropagation(); toggleMaximizeWindow(instanceId); });
            windowEl.querySelector('[data-action="close"]').addEventListener('click', (ev) => { ev.stopPropagation(); closeWindow(instanceId); });
            
            const app = appConfig[openWindows[instanceId].appId];
            let windowContextMenuItems = [];
            if (app.contextMenuItems && app.contextMenuItems.length > 0) {
                 windowContextMenuItems = [...app.contextMenuItems]; 
            }
            const moveToDesktopSubmenu = virtualDesktops.map(desktopNum => ({
                label: `Desktop ${desktopNum}`,
                icon: openWindows[instanceId].desktop === desktopNum ? "fa-check-circle" : "fa-desktop",
                action: () => moveWindowToDesktop(instanceId, desktopNum)
            }));
            if (windowContextMenuItems.length > 0) windowContextMenuItems.push({ isDivider: true });
            windowContextMenuItems.push({ label: "Move to Desktop...", icon: "fa-arrow-right-to-bracket", items: moveToDesktopSubmenu, isSubmenuPlaceholder: true });


            if (windowContextMenuItems.length > 0) {
                 const eventTargetForContextMenu = titleBar; 
                 eventTargetForContextMenu.addEventListener('contextmenu', (e) => { e.preventDefault(); e.stopPropagation(); displayContextMenu(e.clientX, e.clientY, windowContextMenuItems, windowEl, `window-${instanceId}`); });
                let appLongPressTimer = null;
                eventTargetForContextMenu.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) { clearTimeout(appLongPressTimer); appLongPressTimer = setTimeout(() => { e.preventDefault(); e.stopPropagation(); displayContextMenu(e.touches[0].clientX, e.touches[0].clientY, windowContextMenuItems, windowEl, `window-${instanceId}`); }, LONG_PRESS_DURATION); }
                }, { passive: true }); 
                eventTargetForContextMenu.addEventListener('touchmove', () => clearTimeout(appLongPressTimer));
                eventTargetForContextMenu.addEventListener('touchend', () => clearTimeout(appLongPressTimer));
            }
        }

        function focusWindow(instanceId) {
            const windowData = openWindows[instanceId];
            if (!windowData || (activeWindowId === instanceId && windowData.element.style.zIndex == highestZIndex)) return;
            highestZIndex++; windowData.element.style.zIndex = highestZIndex;
            if(activeWindowId && openWindows[activeWindowId]) openWindows[activeWindowId].element.classList.remove('focused');
            windowData.element.classList.add('focused'); activeWindowId = instanceId;
            updateAppMenuBar(windowData.appId, windowData.name);
            updateDockActiveState(windowData.appId);
        }
        
        function focusDesktop() {
            if(activeWindowId && openWindows[activeWindowId]) openWindows[activeWindowId].element.classList.remove('focused');
            activeWindowId = null;
            updateAppMenuBar(null, "Desktop"); 
            updateDockActiveState(null);
        }


        function updateAppMenuBar(appId, appName) {
            if (!appMenuBarContainer) return;
            appMenuBarContainer.innerHTML = ''; 
            const showMenuBar = !!(appId || appName === "Desktop"); 
            appMenuBarContainer.classList.toggle('hidden', !showMenuBar && !appMenuBarContainer.classList.contains('sm:flex'));
            appMenuBarContainer.classList.toggle('sm:flex', showMenuBar);


            if (appId && appConfig[appId] && appConfig[appId].menuBar) {
                const appData = appConfig[appId];
                const appTitleEl = document.createElement('div');
                appTitleEl.className = 'menubar-item app-title';
                appTitleEl.textContent = appData.name;
                appMenuBarContainer.appendChild(appTitleEl);

                appData.menuBar.forEach(menu => {
                    const menuEl = document.createElement('button');
                    menuEl.className = 'menubar-item';
                    menuEl.textContent = menu.label;
                    menuEl.onclick = (e) => {
                        e.stopPropagation();
                        const rect = menuEl.getBoundingClientRect();
                        if (activeMenuBarDropdown && activeMenuBarDropdown.dataset.menuLabel === menu.label) {
                            closeActiveMenuBarDropdown();
                        } else {
                            closeActiveMenuBarDropdown(); 
                            // Pass actions if they are simple functions, or wrap them if they need winEl
                            const processedItems = menu.items.map(item => {
                                if (item.action && typeof item.action === 'function' && item.action.length === 0) { // No args, direct call
                                    return item;
                                } else if (item.action) { // Needs winEl or other context
                                    return { ...item, action: () => item.action(openWindows[activeWindowId]?.element) };
                                }
                                return item; // No action or already processed
                            });
                            displayContextMenu(rect.left, rect.bottom + 2, processedItems, openWindows[activeWindowId]?.element, menu.label);
                            activeMenuBarDropdown = contextMenuEl; 
                            activeMenuBarDropdown.dataset.menuLabel = menu.label; 
                        }
                    };
                    appMenuBarContainer.appendChild(menuEl);
                });
            } else if (appName === "Desktop") { 
                 const desktopTitleEl = document.createElement('div');
                desktopTitleEl.className = 'menubar-item app-title';
                desktopTitleEl.textContent = "Desktop";
                appMenuBarContainer.appendChild(desktopTitleEl);
                const desktopMenu = { label: "View", items: [{label: "Change Wallpaper", icon: "fa-palette", action: () => changeWallpaperContext()}] };
                 const menuEl = document.createElement('button');
                    menuEl.className = 'menubar-item';
                    menuEl.textContent = desktopMenu.label;
                    menuEl.onclick = (e) => {
                        e.stopPropagation();
                        const rect = menuEl.getBoundingClientRect();
                        if (activeMenuBarDropdown && activeMenuBarDropdown.dataset.menuLabel === desktopMenu.label) {
                            closeActiveMenuBarDropdown();
                        } else {
                            closeActiveMenuBarDropdown(); 
                            displayContextMenu(rect.left, rect.bottom + 2, desktopMenu.items, null, desktopMenu.label);
                            activeMenuBarDropdown = contextMenuEl; 
                            activeMenuBarDropdown.dataset.menuLabel = desktopMenu.label; 
                        }
                    };
                appMenuBarContainer.appendChild(menuEl);
            }
        }
        
        function closeActiveMenuBarDropdown() {
            if (activeMenuBarDropdown) {
                activeMenuBarDropdown.classList.remove('show');
                activeMenuBarDropdown.style.display = 'none';
                activeMenuBarDropdown = null;
            }
        }


        function toggleMinimizeWindow(instanceId) {
            const windowData = openWindows[instanceId]; if (!windowData) return;
            windowData.minimized = !windowData.minimized; 
            windowData.element.classList.toggle('minimized', windowData.minimized);
            showTemporaryMessage(`${windowData.name} ${windowData.minimized ? 'minimized' : 'restored'}.`, 1500);
            if (windowData.minimized && activeWindowId === instanceId) focusDesktop();
            else if (!windowData.minimized) focusWindow(instanceId);
            updateDockActiveState(windowData.appId);
        }

        function toggleMaximizeWindow(instanceId) {
            const windowData = openWindows[instanceId]; if (!windowData) return;
            const maximizeIcon = windowData.element.querySelector('[data-action="maximize"] i');
            windowData.isMaximized = !windowData.isMaximized; 
            windowData.element.classList.toggle('maximized', windowData.isMaximized);
            const titleBar = windowData.element.querySelector('.window-title-bar');
            if (windowData.isMaximized) {
                windowData.originalRect = { top: windowData.element.style.top, left: windowData.element.style.left, width: windowData.element.style.width, height: windowData.element.style.height };
                maximizeIcon.classList.replace('fa-square', 'fa-window-restore'); titleBar.style.cursor = 'default';
                showTemporaryMessage(`${windowData.name} maximized.`, 1200);
            } else {
                if (windowData.originalRect) Object.assign(windowData.element.style, windowData.originalRect);
                maximizeIcon.classList.replace('fa-window-restore', 'fa-square'); titleBar.style.cursor = 'grab';
                windowData.originalRect = null;
                showTemporaryMessage(`${windowData.name} restored.`, 1200);
            }
            focusWindow(instanceId);
        }

        function closeWindow(instanceId) {
            const windowData = openWindows[instanceId]; if (!windowData) return;
            windowData.element.classList.add('closing');
            showTemporaryMessage(`Closing ${windowData.name}...`, 1000);
            windowData.element.addEventListener('transitionend', () => {
                windowData.element.remove(); delete openWindows[instanceId];
                if (activeWindowId === instanceId) focusDesktop();
                initializeDock(); // Refresh dock to remove icon if it was the last instance of a non-pinned app
            }, { once: true });
        }
        

        function initializeDock() {
            if (!dock) return;
            dock.innerHTML = ''; 
            Object.keys(appConfig).forEach(appId => {
                const app = appConfig[appId];
                // App Launcher is now pinned, so it will be handled like other pinned apps.
                // No special exclusion needed here anymore for app-launcher.
                if (app.isPinnedToDock === undefined && appId !== 'app-launcher') app.isPinnedToDock = true; // Default to pinned for most apps
                else if (app.isPinnedToDock === undefined && appId === 'app-launcher') app.isPinnedToDock = true; // Ensure app-launcher is pinned

                const hasOpenInstances = Object.values(openWindows).some(win => win.appId === appId);
                if (app.isPinnedToDock || hasOpenInstances) {
                    const button = document.createElement('button');
                    button.className = 'dock-icon p-2.5 md:p-3 rounded-full text-xl relative'; 
                    button.title = `Open ${app.name}`;
                    button.innerHTML = `<i class="${app.icon} ${app.color || 'text-[var(--icon-color)]'}"></i>`;
                    button.dataset.appId = appId; 
                    button.onclick = (event) => launchOrFocusApp(appId, event.currentTarget); 
                    
                    button.oncontextmenu = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const openInstancesOfThisApp = Object.values(openWindows).filter(win => win.appId === appId);
                        
                        let dockContextMenu = [
                            { label: `Open New ${app.name}`, icon: "fa-plus-circle", action: () => createWindow(appId, {}, currentVirtualDesktop) },
                        ];

                        if (openInstancesOfThisApp.length > 0) {
                            dockContextMenu.push({isDivider: true});
                            openInstancesOfThisApp.forEach(instance => {
                                const instanceNumber = instance.element.id.split('-').pop();
                                let label = `${instance.name} ${app.allowMultiple && openInstancesOfThisApp.length > 1 ? `(#${instanceNumber})` : ''} on D${instance.desktop}`;
                                if (instance.minimized) label += " (minimized)";
                                dockContextMenu.push({
                                    label: label,
                                    icon: instance.minimized ? 'fa-window-maximize' : (instance.desktop === currentVirtualDesktop && instance.element.id === activeWindowId ? 'fa-eye' : 'fa-external-link-square-alt'),
                                    action: () => {
                                        if (instance.desktop !== currentVirtualDesktop) switchVirtualDesktop(instance.desktop, true);
                                        setTimeout(() => {
                                            if (instance.minimized) toggleMinimizeWindow(instance.element.id);
                                            focusWindow(instance.element.id);
                                        }, 50);
                                    }
                                });
                            });
                            dockContextMenu.push({isDivider: true});
                            dockContextMenu.push({ label: "Close All Instances", icon: "fa-times-circle", action: () => openInstancesOfThisApp.forEach(win => closeWindow(win.element.id)) });
                        }
                        
                        // Pin/Unpin only for non-app-launcher apps, launcher is always pinned now.
                        if (appId !== 'app-launcher') {
                            dockContextMenu.push({isDivider: true});
                            dockContextMenu.push(
                                app.isPinnedToDock 
                                    ? { label: "Unpin from Dock", icon: "fa-thumbtack", action: () => { app.isPinnedToDock = false; initializeDock(); showTemporaryMessage(`${app.name} unpinned.`, 1500); } }
                                    : { label: "Pin to Dock", icon: "fa-thumbtack", action: () => { app.isPinnedToDock = true; initializeDock(); showTemporaryMessage(`${app.name} pinned.`, 1500); } }
                            );
                        }
                        displayContextMenu(e.clientX, e.clientY, dockContextMenu, null, `dock-${appId}`);
                    };

                    dock.appendChild(button); 
                    app.dockElement = button;
                } else {
                    if (app.dockElement) { 
                        app.dockElement.remove();
                        delete app.dockElement;
                    }
                }
            });
            updateDockActiveState(activeWindowId ? openWindows[activeWindowId]?.appId : null);
        }

        function launchOrFocusApp(appId, dockButtonElement = null) {
            const app = appConfig[appId];
            if (!app) return;

            const allInstancesOfApp = Object.values(openWindows).filter(win => win.appId === appId);
            const activeInstancesOnCurrentDesktop = allInstancesOfApp.filter(win => win.desktop === currentVirtualDesktop && !win.minimized);

            if (allInstancesOfApp.length > 0 && dockButtonElement) { // Clicked on dock icon
                if (activeInstancesOnCurrentDesktop.length > 0 && activeInstancesOnCurrentDesktop[0].element.id === activeWindowId && !app.allowMultiple) {
                    // If it's the active window of a single-instance app, minimize it
                    toggleMinimizeWindow(activeWindowId);
                    return;
                }

                const instanceMenuItems = allInstancesOfApp.map(instance => {
                    const instanceNumber = instance.element.id.split('-').pop();
                    let label = `${instance.name} ${app.allowMultiple && allInstancesOfApp.length > 1 ? `(#${instanceNumber})` : ''} on D${instance.desktop}`;
                    if (instance.minimized) label += " (minimized)";
                    return {
                        label: label,
                        icon: instance.minimized ? 'fa-window-maximize' : (instance.desktop === currentVirtualDesktop && instance.element.id === activeWindowId ? 'fa-eye' : 'fa-external-link-square-alt'),
                        action: () => {
                            if (instance.desktop !== currentVirtualDesktop) switchVirtualDesktop(instance.desktop, true);
                            setTimeout(() => {
                                if (instance.minimized) toggleMinimizeWindow(instance.element.id);
                                focusWindow(instance.element.id);
                            }, 50);
                        }
                    };
                });

                if (app.allowMultiple || appId === 'app-launcher') { // Allow opening new for app-launcher too if desired
                    instanceMenuItems.push({ isDivider: true });
                    instanceMenuItems.push({
                        label: `Open New on Desktop ${currentVirtualDesktop}`,
                        icon: "fa-plus-circle",
                        action: () => createWindow(appId, {}, currentVirtualDesktop)
                    });
                }
                
                const rect = dockButtonElement.getBoundingClientRect();
                displayContextMenu(rect.left, rect.top - 10, instanceMenuItems, null, `dockAppInstancePicker-${appId}`, true); // fromBottom = true
            
            } else if (allInstancesOfApp.length > 0 && !app.allowMultiple) { 
                 const instance = allInstancesOfApp[0]; // Focus the single instance
                 if (instance.desktop !== currentVirtualDesktop) switchVirtualDesktop(instance.desktop, true);
                 setTimeout(() => {
                    if (instance.minimized) toggleMinimizeWindow(instance.element.id);
                    else focusWindow(instance.element.id);
                 }, 50);
            } else { // No instances open, or launching not from dock (e.g., app launcher button, desktop icon)
                createWindow(appId, {}, currentVirtualDesktop); 
            }
        }


        function updateDockActiveState(activeAppIdParam) {
            Object.keys(appConfig).forEach(appId => {
                // No exclusion for app-launcher here, it's a normal dock item now.
                const app = appConfig[appId]; 
                if (!app.dockElement && (app.isPinnedToDock || Object.values(openWindows).some(win => win.appId === appId))) {
                    initializeDock(); 
                    return; 
                }
                if (!app.dockElement) return; 

                const hasOpenNotMinimizedInstanceOnCurrentDesktop = Object.values(openWindows).some(win => win.appId === appId && !win.minimized && win.desktop === currentVirtualDesktop);
                const isCurrentlyFocusedAppType = activeWindowId && openWindows[activeWindowId] && openWindows[activeWindowId].appId === appId;
                
                app.dockElement.classList.toggle('active', isCurrentlyFocusedAppType && hasOpenNotMinimizedInstanceOnCurrentDesktop);
                
                const hasAnyOpenInstanceAnywhere = Object.values(openWindows).some(win => win.appId === appId);
                let dot = app.dockElement.querySelector('.open-dot');
                if (hasAnyOpenInstanceAnywhere) { 
                    if (!dot) { 
                        dot = document.createElement('span'); 
                        dot.className = 'open-dot absolute bottom-1 left-1/2 transform -translate-x-1/2 w-1.5 h-1.5 bg-[var(--accent-color)] rounded-full'; 
                        app.dockElement.appendChild(dot); 
                    } 
                } else { 
                    if (dot) dot.remove(); 
                    if (!app.isPinnedToDock && app.dockElement) { 
                        app.dockElement.remove();
                        delete app.dockElement;
                    }
                }
            });
        }

        function displayContextMenu(x, y, menuItems, targetWindowEl = null, menuId = null, fromBottom = false) {
            if (!contextMenuEl) return;
            closeActiveMenuBarDropdown(); 
            contextMenuEl.innerHTML = '';
            if (menuId) contextMenuEl.dataset.menuId = menuId; else delete contextMenuEl.dataset.menuId;

            if (!menuItems || menuItems.length === 0) {
                showTemporaryMessage("No specific options for this item.", 1500);
                return;
            }
            menuItems.forEach(item => {
                if (item.isDivider) { const divider = document.createElement('div'); divider.className = 'context-menu-divider'; contextMenuEl.appendChild(divider); return; }
                const menuItemEl = document.createElement('div'); menuItemEl.className = 'context-menu-item';
                menuItemEl.innerHTML = `<i class="fas ${item.icon || 'fa-empty-set'} fa-fw"></i><span>${item.label}</span>`;
                
                if (item.items && item.items.length > 0) { 
                    menuItemEl.classList.add('has-submenu');
                    menuItemEl.onclick = (e) => {
                        e.stopPropagation(); 
                        const rect = menuItemEl.getBoundingClientRect();
                        let subX = rect.right;
                        if (subX + contextMenuEl.offsetWidth > window.innerWidth) {
                            subX = rect.left - contextMenuEl.offsetWidth;
                        }
                        displayContextMenu(subX, rect.top, item.items, targetWindowEl, `${menuId}-sub-${item.label.replace(/\s+/g, '')}`, false);
                    };
                } else {
                    menuItemEl.onclick = (e) => { 
                        e.stopPropagation(); 
                        const currentTargetWindow = targetWindowEl || (activeWindowId ? openWindows[activeWindowId].element : null);
                        if (item.action) item.action(currentTargetWindow); 
                        contextMenuEl.classList.remove('show'); 
                        contextMenuEl.style.display = 'none'; 
                        if (activeMenuBarDropdown === contextMenuEl) activeMenuBarDropdown = null; 
                        let parentMenu = contextMenuEl.dataset.parentMenuId ? document.querySelector(`.context-menu[data-menu-id="${contextMenuEl.dataset.parentMenuId}"]`) : null;
                        while(parentMenu) {
                            parentMenu.classList.remove('show'); parentMenu.style.display = 'none';
                            parentMenu = parentMenu.dataset.parentMenuId ? document.querySelector(`.context-menu[data-menu-id="${parentMenu.dataset.parentMenuId}"]`) : null;
                        }
                    };
                }
                contextMenuEl.appendChild(menuItemEl);
            });
            
            contextMenuEl.style.visibility = 'hidden';
            contextMenuEl.style.display = 'block';
            const menuHeight = contextMenuEl.offsetHeight;
            const menuWidth = contextMenuEl.offsetWidth;
            contextMenuEl.style.visibility = 'visible'; 
            
            let finalY = y;
            if (fromBottom) { 
                 finalY = y - menuHeight - 5; // Adjusted for better placement from bottom
            }
            finalY = Math.max(10, Math.min(finalY, window.innerHeight - menuHeight - 10)); 
            let finalX = x;
            if (finalX + menuWidth > window.innerWidth -10) finalX = window.innerWidth - menuWidth - 10;
            finalX = Math.max(10, finalX);


            contextMenuEl.style.top = `${finalY}px`;
            contextMenuEl.style.left = `${finalX}px`;
            void contextMenuEl.offsetWidth; 
            contextMenuEl.classList.add('show'); 
            
            if (menuId && !menuId.startsWith("dockAppInstancePicker") && menuId !== "desktopContextMenu" && !menuId.includes("-sub-")) { 
                 activeMenuBarDropdown = contextMenuEl;
                 activeMenuBarDropdown.dataset.menuLabel = menuId; 
            }
        }
        
        const desktopContextMenuItems = [
            {label: "Change Wallpaper", icon: "fa-palette", action: () => changeWallpaperContext()},
            {label: "Set Wallpaper from URL", icon: "fa-link", action: () => promptForWallpaperURL()},
            {isDivider: true},
            {label: "Display Settings (mock)", icon: "fa-desktop", action: () => showTemporaryMessage("Opening Display settings...", 1500)},
            {label: "System Settings", icon: "fa-cog", action: () => createWindow('settings')} 
        ];
        
        function changeWallpaperContext(fromSidebar = false, initialLoad = false) {
            if (!wallpaperContainer) return;
            if (!initialLoad) { 
                currentWallpaperIdx = (currentWallpaperIdx + 1) % wallpapers.length;
            }
            const selectedWallpaper = wallpapers[currentWallpaperIdx];

            if (selectedWallpaper.url) {
                wallpaperContainer.className = 'wallpaper'; 
                wallpaperContainer.style.backgroundImage = `url('${selectedWallpaper.url}')`;
                wallpaperContainer.style.backgroundSize = 'cover';
                wallpaperContainer.style.backgroundPosition = 'center center';
                wallpaperContainer.style.backgroundBlendMode = ''; 
            } else { 
                wallpaperContainer.style.backgroundImage = ''; 
                wallpaperContainer.className = `wallpaper ${selectedWallpaper.class || ''}`;
            }
            if (!initialLoad) showTemporaryMessage(`Wallpaper set to: ${selectedWallpaper.name}.`, 1500);
            if (!fromSidebar && !initialLoad && contextMenuEl) { contextMenuEl.classList.remove('show'); contextMenuEl.style.display = 'none';}
        }

        function promptForWallpaperURL() {
            if(contextMenuEl) { contextMenuEl.classList.remove('show'); contextMenuEl.style.display = 'none';}
            const url = window.prompt("Enter image URL for wallpaper:", "");
            if (url && url.trim() !== "") {
                if (!wallpaperContainer) return;
                wallpaperContainer.className = 'wallpaper'; 
                wallpaperContainer.style.backgroundImage = `url('${url.trim()}')`;
                wallpaperContainer.style.backgroundSize = 'cover';
                wallpaperContainer.style.backgroundPosition = 'center center';
                const existingWallpaperIndex = wallpapers.findIndex(wp => wp.url === url.trim());
                currentWallpaperIdx = existingWallpaperIndex !== -1 ? existingWallpaperIndex : -1; 
                showTemporaryMessage("Custom wallpaper set.", 2000);
            } else if (url !== null) { 
                showTemporaryMessage("No URL entered. Wallpaper not changed.", 1500);
            }
        }
        
        let overviewActive = false; const originalWindowsState = [];
        
        function toggleQuickSetting(button, settingName) {
            const statusEl = button.querySelector('span:last-child'); const isOn = statusEl.textContent === 'On';
            statusEl.textContent = isOn ? 'Off' : 'On'; statusEl.classList.toggle('text-[var(--secondary-accent)]', !isOn); statusEl.classList.toggle('text-[var(--error-color)]', isOn); statusEl.classList.remove('hidden');
            showTemporaryMessage(`${settingName} ${isOn ? 'turned off' : 'turned on'}.`,1500);
        }

        const calMonthYear = document.getElementById('cal-month-year');
        const calDays = document.getElementById('cal-days'); let currentCalDate = new Date(2025, 4, 31); 
        function renderCalendar() {
            if (!calMonthYear || !calDays) return;
            calMonthYear.textContent = currentCalDate.toLocaleDateString([], { month: 'long', year: 'numeric' }); calDays.innerHTML = ''; 
            const month = currentCalDate.getMonth(); const year = currentCalDate.getFullYear();
            const firstDayOfMonth = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate();
            ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(d => { const dayLabel = document.createElement('span'); dayLabel.className = 'text-[var(--text-secondary)] font-medium text-xs'; dayLabel.textContent = d; calDays.appendChild(dayLabel); });
            for (let i = 0; i < firstDayOfMonth; i++) calDays.appendChild(document.createElement('span'));
            for (let day = 1; day <= daysInMonth; day++) {
                const dayEl = document.createElement('button'); dayEl.className = 'p-1 rounded-full hover:bg-[var(--surface-active-bg)] active:bg-[var(--surface-active-bg)] transition-colors text-xs w-7 h-7 mx-auto flex items-center justify-center'; dayEl.textContent = day;
                const today = new Date();
                if (day === today.getDate() && month === today.getMonth() && year === today.getFullYear()) dayEl.classList.add('!bg-[var(--accent-color)]', '!text-[var(--primary-bg)]', 'font-medium');
                else if (day === 31 && month === 4 && year === 2025) dayEl.classList.add('ring-1', 'ring-[var(--accent-color)]');
                dayEl.onclick = () => showTemporaryMessage(`Calendar: ${month+1}/${day}/${year}`,1500); calDays.appendChild(dayEl);
            }
        }
                        
        function updateVirtualDesktopSwitcherUI() {
            if (!vDesktopSwitcher) return;
            vDesktopSwitcher.innerHTML = ''; 
            virtualDesktops.forEach(desktopNum => {
                const container = document.createElement('div');
                container.className = 'vdesktop-button-container';

                const button = document.createElement('button');
                button.className = 'vdesktop-button px-3 py-1.5 text-xs';
                button.dataset.desktop = desktopNum;
                button.title = `Desktop ${desktopNum}`;
                button.textContent = desktopNum;
                if (desktopNum === currentVirtualDesktop) button.classList.add('active');
                button.onclick = () => switchVirtualDesktop(desktopNum);
                container.appendChild(button);

                if (virtualDesktops.length > 1 && desktopNum !== 1) { 
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-desktop-btn top-panel-item !p-0.5 !absolute';
                    removeBtn.innerHTML = '<i class="fas fa-times text-xs"></i>';
                    removeBtn.title = `Remove Desktop ${desktopNum}`;
                    removeBtn.onclick = (e) => {
                        e.stopPropagation();
                        removeVirtualDesktop(desktopNum);
                    };
                    container.appendChild(removeBtn);
                }
                vDesktopSwitcher.appendChild(container);
            });
        }

        function addVirtualDesktop() {
            if (virtualDesktops.length >= 8) { 
                showTemporaryMessage("Maximum number of desktops reached.", 2000);
                return;
            }
            // Ensure nextDesktopId is always higher than the max existing ID
            nextDesktopId = virtualDesktops.length > 0 ? Math.max(...virtualDesktops) + 1 : 1;
            if (virtualDesktops.includes(nextDesktopId)) { // Double check if somehow it's already there
                 nextDesktopId = Math.max(...virtualDesktops, nextDesktopId) + 1;
            }

            virtualDesktops.push(nextDesktopId);
            showTemporaryMessage(`Desktop ${nextDesktopId} added.`, 1500);
            updateVirtualDesktopSwitcherUI();
            switchVirtualDesktop(nextDesktopId); 
        }

        function removeVirtualDesktop(desktopIdToRemove) {
            if (virtualDesktops.length <= 1) {
                showTemporaryMessage("Cannot remove the last desktop.", 2000);
                return;
            }
            if (desktopIdToRemove === 1 && virtualDesktops.includes(1)) {
                 showTemporaryMessage("Cannot remove the primary desktop (Desktop 1).", 2000);
                return;
            }

            const indexToRemove = virtualDesktops.indexOf(desktopIdToRemove);
            if (indexToRemove === -1) return; 

            const targetDesktopForWindows = virtualDesktops.find(d => d !== desktopIdToRemove && d < desktopIdToRemove) || virtualDesktops.find(d => d !== desktopIdToRemove) || 1;
            Object.values(openWindows).forEach(winData => {
                if (winData.desktop === desktopIdToRemove) {
                    moveWindowToDesktop(winData.element.id, targetDesktopForWindows, false); 
                }
            });

            virtualDesktops.splice(indexToRemove, 1);
            showTemporaryMessage(`Desktop ${desktopIdToRemove} removed. Windows moved to Desktop ${targetDesktopForWindows}.`, 2000);

            if (currentVirtualDesktop === desktopIdToRemove) {
                currentVirtualDesktop = targetDesktopForWindows; 
                switchVirtualDesktop(currentVirtualDesktop, true);
            } else {
                updateVirtualDesktopSwitcherUI(); 
            }
            updateWindowVisibility();
        }


        function switchVirtualDesktop(newDesktopId, forceSwitch = false) {
            if (!virtualDesktops.includes(newDesktopId)) { 
                console.warn(`Attempted to switch to non-existent desktop: ${newDesktopId}`);
                currentVirtualDesktop = virtualDesktops[0] || 1; 
                updateVirtualDesktopSwitcherUI(); 
                return;
            }

            if (newDesktopId !== currentVirtualDesktop || forceSwitch) {
                currentVirtualDesktop = newDesktopId;
                if(!forceSwitch) showTemporaryMessage(`Switched to Desktop ${currentVirtualDesktop}.`,1500);
                updateVirtualDesktopSwitcherUI(); 
                updateWindowVisibility();
                if (activeWindowId && openWindows[activeWindowId] && openWindows[activeWindowId].desktop !== currentVirtualDesktop) focusDesktop();
                 else if (activeWindowId && openWindows[activeWindowId] && openWindows[activeWindowId].desktop === currentVirtualDesktop) {
                    updateAppMenuBar(openWindows[activeWindowId].appId, openWindows[activeWindowId].name); 
                } else {
                    focusDesktop(); 
                }
                // Ensure sidebar state is maintained (open by default)
                if (sidebar && sidebar.classList.contains('translate-x-full')) {
                    // sidebar.classList.remove('translate-x-full'); // Keep it open
                }
            }
        }
        
        function moveWindowToDesktop(windowId, targetDesktopId, switchToTargetDesktop = true) {
            const windowData = openWindows[windowId];
            if (!windowData || !virtualDesktops.includes(targetDesktopId)) return;

            windowData.desktop = targetDesktopId;
            showTemporaryMessage(`${windowData.name} moved to Desktop ${targetDesktopId}.`, 1500);
            
            if (switchToTargetDesktop && currentVirtualDesktop !== targetDesktopId) {
                switchVirtualDesktop(targetDesktopId, true); 
                setTimeout(() => focusWindow(windowId), 50); 
            } else {
                updateWindowVisibility(); 
                if (currentVirtualDesktop === targetDesktopId) {
                    focusWindow(windowId); 
                }
            }
        }


        function updateWindowVisibility() { Object.values(openWindows).forEach(winData => winData.element.classList.toggle('hidden-on-desktop', winData.desktop !== currentVirtualDesktop)); }
        
        let calcCurrentInput = '0'; let calcPreviousInput = ''; let calcOperation = null; let calcDisplayElement = null;
        function calcUpdateDisplay() { if (calcDisplayElement) calcDisplayElement.textContent = calcCurrentInput.toLocaleString('en', { maximumFractionDigits: 8 }); }
        function calcAppend(number) { if (calcCurrentInput.length > 15 && number !== '.') return; if (calcCurrentInput === '0' && number !== '.') calcCurrentInput = ''; if (number === '.' && calcCurrentInput.includes('.')) return; calcCurrentInput += number; calcUpdateDisplay(); }
        function calcClear() { calcCurrentInput = '0'; calcPreviousInput = ''; calcOperation = null; calcUpdateDisplay(); }
        function calcPerformOp(op) {
            if (calcCurrentInput === '' && calcPreviousInput === '') return;
            if (calcPreviousInput !== '' && calcOperation && calcCurrentInput !== '0' && calcCurrentInput !== '') calcEquals(); 
            calcOperation = op; calcPreviousInput = calcCurrentInput; calcCurrentInput = '0';
            if(calcDisplayElement && calcPreviousInput !== '') calcDisplayElement.textContent = parseFloat(calcPreviousInput).toLocaleString('en', { maximumFractionDigits: 8 });
        }
        function calcEquals() {
            if (!calcOperation || calcPreviousInput === '') return;
            let result; const prev = parseFloat(calcPreviousInput); const current = parseFloat(calcCurrentInput);
            if (isNaN(prev) || isNaN(current)) { result = 'Error'; }
            else {
                switch (calcOperation) {
                    case '+': result = prev + current; break; case '-': result = prev - current; break;
                    case '*': result = prev * current; break; case '/': result = current === 0 ? 'Error' : prev / current; break;
                    default: return;
                }
            }
            calcCurrentInput = (typeof result === 'number' && result.toString().length > 15 && Math.abs(result) > 1e-7) ? result.toExponential(7) : result.toString();
            calcOperation = null; calcPreviousInput = ''; calcUpdateDisplay();
        }

        async function handleNotepadSummarize(windowEl) { 
            if (!windowEl) windowEl = activeWindowId ? openWindows[activeWindowId].element : null;
            if (!windowEl) { showTemporaryMessage("No active note window.", 2000); return; }
            const summarizeBtn = windowEl.querySelector('#summarize-note-btn'); if (summarizeBtn) summarizeBtn.click(); 
        }
        async function handleNotepadSuggestTitle(windowEl) { 
            if (!windowEl) windowEl = activeWindowId ? openWindows[activeWindowId].element : null;
            if (!windowEl) { showTemporaryMessage("No active note window.", 2000); return; }
            const suggestTitleBtn = windowEl.querySelector('#suggest-title-btn'); if (suggestTitleBtn) suggestTitleBtn.click(); 
        }

        async function handleTerminalExplain(windowEl) {
            if (!windowEl) windowEl = activeWindowId ? openWindows[activeWindowId].element : null;
            if (!windowEl) { showTemporaryMessage("No active terminal window.", 2000); return; }
            const outputEl = windowEl.querySelector('.terminal-output');
            if (lastTerminalCommand && !lastTerminalCommand.toLowerCase().startsWith('explain ')) {
                 outputEl.innerHTML += `<div><span class="explanation">Requesting explanation for last command: ${lastTerminalCommand.replace(/</g, "&lt;").replace(/>/g, "&gt;")}...</span></div>`;
                 outputEl.scrollTop = outputEl.scrollHeight;
                 const explanation = await callGeminiAPI(`Explain the following Linux/bash command simply and concisely: ${lastTerminalCommand}`);
                 outputEl.innerHTML += `<div><span class="explanation">${explanation.replace(/\n/g, "<br>")}</span></div>`;
                 outputEl.scrollTop = outputEl.scrollHeight;
            } else if (lastTerminalCommand.toLowerCase().startsWith('explain ')) { showTemporaryMessage("Already explained or 'explain' was the last command.", 2500); }
            else { showTemporaryMessage("No previous command to explain.", 2000); }
        }

        function mockTerminalAction(action, winEl) { 
            if (!winEl && activeWindowId) winEl = openWindows[activeWindowId].element;
            if (winEl && winEl.dataset.appId === "terminal") {
                if (action === "Clear" || action === "Clear Scrollback") { 
                    const outputEl = winEl.querySelector('.terminal-output');
                    if (outputEl) outputEl.innerHTML = (action === "Clear Scrollback" ? `<div>Scrollback cleared. Current path: ${currentTerminalPath}</div>` : `Current path: ${currentTerminalPath}`);
                }
            }
            showTemporaryMessage(`Terminal: ${action} (mocked for ${winEl ? winEl.id : 'unknown window'})`, 1500); 
        }
        function mockTextAction(action, winEl) { showTemporaryMessage(`Editor: ${action} (mocked for ${winEl ? winEl.id : 'unknown window'})`, 1500); }

        function selectMailFolder(element, folderName) {
            const mailWindow = element.closest('.window');
            if (!mailWindow) return;
            const sidebarItems = mailWindow.querySelectorAll('.mail-sidebar-item');
            sidebarItems.forEach(item => item.classList.remove('active'));
            element.classList.add('active');
            showTemporaryMessage(`Selected folder: ${folderName}`, 1000);
            
            const list = mailWindow.querySelector('.mail-message-list');
            const previewSubject = mailWindow.querySelector('#mail-preview-subject');
            const previewBody = mailWindow.querySelector('#mail-preview-body');

            if(list) list.innerHTML = `<div class="mail-message-list-item" onclick="showMailPreview(this.closest('.window'), 'Mock Email 1 for ${folderName}', 'Content for email 1 in ${folderName}...')"><strong>Mock Email 1 for ${folderName}</strong> - Preview...</div><div class="mail-message-list-item" onclick="showMailPreview(this.closest('.window'), 'Mock Email 2 for ${folderName}', 'Content for email 2 in ${folderName}...')"><strong>Mock Email 2 for ${folderName}</strong> - Preview...</div>`;
            if(previewSubject) previewSubject.textContent = `Messages in ${folderName}`;
            if(previewBody) previewBody.textContent = `Select an email to view its content.`;
        }
        function showMailPreview(mailWindow, subject, body) {
            if (!mailWindow) return;
            const previewSubject = mailWindow.querySelector('#mail-preview-subject');
            const previewBody = mailWindow.querySelector('#mail-preview-body');
            if(previewSubject) previewSubject.textContent = subject;
            if(previewBody) previewBody.textContent = body;
        }
        
        let folderDragInfo = { dragging: false, offsetX: 0, offsetY: 0 };
        function makeFolderDraggable(folderEl, appIdToLaunchOnClick = null) {
            let isDraggingForClickCheck = false; 

            folderEl.addEventListener('mousedown', (e) => {
                if (e.button !== 0) return; 
                e.preventDefault();
                isDraggingForClickCheck = false;
                folderDragInfo.dragging = true;
                const rect = folderEl.getBoundingClientRect();
                folderDragInfo.offsetX = e.clientX - rect.left;
                folderDragInfo.offsetY = e.clientY - rect.top;
                folderEl.style.cursor = 'grabbing';
                document.addEventListener('mousemove', onFolderDrag);
                document.addEventListener('mouseup', stopFolderDrag);
            });
             folderEl.addEventListener('touchstart', (e) => {
                e.preventDefault(); 
                isDraggingForClickCheck = false;
                folderDragInfo.dragging = true;
                const rect = folderEl.getBoundingClientRect();
                folderDragInfo.offsetX = e.touches[0].clientX - rect.left;
                folderDragInfo.offsetY = e.touches[0].clientY - rect.top;
                folderEl.style.cursor = 'grabbing';
                document.addEventListener('touchmove', onFolderDrag, { passive: false });
                document.addEventListener('touchend', stopFolderDrag);
            }, { passive: false });


            function onFolderDrag(e) {
                if (!folderDragInfo.dragging) return;
                isDraggingForClickCheck = true; 
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                let newX = clientX - folderDragInfo.offsetX;
                let newY = clientY - folderDragInfo.offsetY;
                const desktopRect = desktopArea.getBoundingClientRect();
                newX = Math.max(0, Math.min(newX, desktopRect.width - folderEl.offsetWidth));
                newY = Math.max(0, Math.min(newY, desktopRect.height - folderEl.offsetHeight));
                folderEl.style.left = `${newX}px`;
                folderEl.style.top = `${newY}px`;
            }

            function stopFolderDrag() {
                folderDragInfo.dragging = false;
                folderEl.style.cursor = 'grab';
                document.removeEventListener('mousemove', onFolderDrag);
                document.removeEventListener('mouseup', stopFolderDrag);
                document.removeEventListener('touchmove', onFolderDrag);
                document.removeEventListener('touchend', stopFolderDrag);
            }
            folderEl.addEventListener('click', (e) => {
                if (!isDraggingForClickCheck) { 
                    if (appIdToLaunchOnClick) {
                        createWindow(appIdToLaunchOnClick);
                    }
                }
                isDraggingForClickCheck = false; 
            });
        }
        
        function handleLogin() {
            currentUsername = usernameInput.value.trim();
            if (!currentUsername) {
                showTemporaryMessage("Please enter a username.", 2000);
                usernameInput.focus();
                return;
            }

            if (userInfoEl) userInfoEl.textContent = currentUsername;
            document.title = `${currentUsername}'s OSWeb v1`;
            updateUserAvatar(); 

            loginModal.classList.add('hidden');

            topPanel.style.display = 'flex';
            desktopArea.style.display = 'flex';
            dock.style.display = 'flex';
            rightSidebar.style.display = 'block'; 
            rightSidebar.classList.remove('translate-x-full'); // Open sidebar by default

            systemStartTime = Date.now(); 
            initializeDesktop();
        }

        function updateSidebarWeather(showMsg = false) {
            const cityEl = document.getElementById('sidebar-weather-city');
            const tempEl = document.getElementById('sidebar-weather-temp');
            const conditionEl = document.getElementById('sidebar-weather-condition');
            const iconEl = document.getElementById('sidebar-weather-icon');

            const weatherData = [
                { city: "Seaford, NY", temp: "72°F", condition: "Partly Cloudy", icon: "fas fa-cloud-sun", iconColor: "text-yellow-400" },
                { city: "Seaford, NY", temp: "75°F", condition: "Sunny", icon: "fas fa-sun", iconColor: "text-yellow-500" },
                { city: "Seaford, NY", temp: "68°F", condition: "Cloudy", icon: "fas fa-cloud", iconColor: "text-gray-400" },
                { city: "Seaford, NY", temp: "65°F", condition: "Rain Showers", icon: "fas fa-cloud-showers-heavy", iconColor: "text-blue-400" }
            ];
            const randomWeather = weatherData[Math.floor(Math.random() * weatherData.length)];

            if (cityEl) cityEl.textContent = randomWeather.city;
            if (tempEl) tempEl.textContent = randomWeather.temp;
            if (conditionEl) conditionEl.textContent = randomWeather.condition;
            if (iconEl) {
                iconEl.className = `${randomWeather.icon} text-2xl mr-2 ${randomWeather.iconColor}`;
            }
            if (showMsg) {
                showTemporaryMessage("Weather updated (mock data).", 1500);
            }
        }
        
        function initializeDesktopEventListeners() {
            sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('translate-x-full'));
            
            desktopArea.addEventListener('click', (event) => {
                if (!sidebar.classList.contains('translate-x-full') && !sidebar.contains(event.target) && !sidebarToggle.contains(event.target) && !event.target.closest('#sidebar-toggle')) {
                    // sidebar.classList.add('translate-x-full'); // Don't auto-close on desktop click if it's default open
                }
                if (activeMenuBarDropdown && !activeMenuBarDropdown.contains(event.target) && !appMenuBarContainer.contains(event.target)) {
                    closeActiveMenuBarDropdown();
                }
                if (contextMenuEl && contextMenuEl.classList.contains('show') && !contextMenuEl.contains(event.target) && !event.target.closest('.context-menu-item')) {
                    contextMenuEl.classList.remove('show');
                    contextMenuEl.style.display = 'none';
                }
            });
            
            desktopArea.addEventListener('contextmenu', (e) => { e.preventDefault(); displayContextMenu(e.clientX, e.clientY, desktopContextMenuItems, null, "desktopContextMenu"); });
            desktopArea.addEventListener('touchstart', (e) => {
                if (e.touches.length === 1 && e.target === desktopArea) { clearTimeout(longPressTimer); longPressTimer = setTimeout(() => { displayContextMenu(e.touches[0].clientX, e.touches[0].clientY, desktopContextMenuItems, null, "desktopContextMenu"); }, LONG_PRESS_DURATION); }
            }, { passive: true });
            desktopArea.addEventListener('touchmove', () => clearTimeout(longPressTimer));
            desktopArea.addEventListener('touchend', () => clearTimeout(longPressTimer));
            
            document.addEventListener('click', (e) => { 
                if (contextMenuEl && contextMenuEl.classList.contains('show') && !contextMenuEl.contains(e.target) && e.target !== contextMenuEl) { 
                    if (activeMenuBarDropdown === contextMenuEl && appMenuBarContainer && appMenuBarContainer.contains(e.target)) { /* Keep open */ } 
                    else { closeActiveMenuBarDropdown(); contextMenuEl.classList.remove('show'); contextMenuEl.style.display = 'none'; }
                }
            });
            document.addEventListener('touchstart', (e) => { 
                 if (contextMenuEl && contextMenuEl.classList.contains('show') && !contextMenuEl.contains(e.target) && e.target !== contextMenuEl) { 
                    if (activeMenuBarDropdown === contextMenuEl && appMenuBarContainer && appMenuBarContainer.contains(e.target)) { /* Keep open */ } 
                    else { closeActiveMenuBarDropdown(); contextMenuEl.classList.remove('show'); contextMenuEl.style.display = 'none'; }
                }
            }, { passive: true });

            activitiesButton.addEventListener('click', () => {
                if (!overviewActive) {
                    originalWindowsState.length = 0; let count = 0;
                    Object.values(openWindows).forEach(winData => { if (winData.element && !winData.minimized && winData.desktop === currentVirtualDesktop) { originalWindowsState.push({ id: winData.element.id, top: winData.element.style.top, left: winData.element.style.left, width: winData.element.style.width, height: winData.element.style.height, zIndex: winData.element.style.zIndex, isMaximized: winData.isMaximized }); count++; } });
                    if (count === 0) { showTemporaryMessage(`No open windows on Desktop ${currentVirtualDesktop}.`,1500); return; }
                    desktopArea.classList.add('!bg-opacity-60', '!bg-black'); 
                    const numCols = Math.max(1, Math.ceil(Math.sqrt(count))); const numRows = Math.max(1, Math.ceil(count / numCols));
                    const cellWidth = desktopArea.clientWidth / numCols; const cellHeight = desktopArea.clientHeight / numRows; const padding = Math.min(20, cellWidth * 0.1, cellHeight * 0.1);
                    originalWindowsState.forEach((winState, index) => {
                        const winEl = openWindows[winState.id].element; const r = Math.floor(index / numCols); const c = index % numCols;
                        Object.assign(winEl.style, { transition: 'all 0.28s cubic-bezier(0.4,0,0.2,1)', width: `${Math.max(MIN_WINDOW_WIDTH * 0.8, cellWidth - padding * 2)}px`, height: `${Math.max(MIN_WINDOW_HEIGHT * 0.8, cellHeight - padding * 2)}px`, top: `${r * cellHeight + padding}px`, left: `${c * cellWidth + padding}px`, zIndex: 1000 + index });
                        if (winState.isMaximized) winEl.classList.remove('maximized');
                        winEl.querySelector('.resize-handle').style.display = 'none';
                    });
                    overviewActive = true; activitiesButton.classList.add('!bg-[var(--accent-color)]', '!text-[var(--primary-bg)]');
                } else {
                    desktopArea.classList.remove('!bg-opacity-60', '!bg-black');
                    originalWindowsState.forEach(orig => { const winEl = openWindows[orig.id]?.element; if(winEl) {Object.assign(winEl.style, { transition: 'all 0.28s cubic-bezier(0.4,0,0.2,1)', top: orig.top, left: orig.left, width: orig.width, height: orig.height, zIndex: orig.zIndex }); if (orig.isMaximized) winEl.classList.add('maximized'); winEl.querySelector('.resize-handle').style.display = ''; }});
                    setTimeout(() => originalWindowsState.forEach(orig => {if(openWindows[orig.id] && openWindows[orig.id].element) openWindows[orig.id].element.style.transition = ''}), 280);
                    overviewActive = false; activitiesButton.classList.remove('!bg-[var(--accent-color)]', '!text-[var(--primary-bg)]');
                    if (activeWindowId && openWindows[activeWindowId]) focusWindow(activeWindowId); else focusDesktop();
                }
            });

            document.getElementById('notifications-container').addEventListener('click', (e) => {
                if (e.target.classList.contains('dismiss-notification') || e.target.closest('.dismiss-notification')) {
                    e.target.closest('.notification').remove();
                    showTemporaryMessage('Notification dismissed.', 1500);
                }
            });
            
            document.getElementById('cal-prev').addEventListener('click', () => { currentCalDate.setMonth(currentCalDate.getMonth() - 1); renderCalendar(); });
            document.getElementById('cal-next').addEventListener('click', () => { currentCalDate.setMonth(currentCalDate.getMonth() + 1); renderCalendar(); });
            
            globalSearchInput.addEventListener('keypress', function(e) { 
                if (e.key === 'Enter' && this.value.trim() !== '') { 
                    const query = this.value.trim();
                    const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(query)}`;
                    createWindow('web-browser', { url: searchUrl }); 
                    this.value = ''; 
                } 
            });

            addDesktopButtonEl.addEventListener('click', addVirtualDesktop);
            
            // Event listener for the new App Launcher button in the top panel
            if (appLauncherButton) {
                appLauncherButton.addEventListener('click', () => launchOrFocusApp('app-launcher'));
            }
            
            themeToggleButton.addEventListener('click', () => {
                currentThemeIndex = (currentThemeIndex + 1) % themes.length;
                document.body.className = ''; // Clear all body classes first

                const newThemeSlug = themes[currentThemeIndex];
                let themeUserFriendlyName = "";
                const themeIcon = themeToggleButton.querySelector('i');

                if (newThemeSlug !== 'default-dark') { // Apply specific theme class if not default dark
                    document.body.classList.add(newThemeSlug);
                }
                
                if (newThemeSlug === 'light-mode') themeUserFriendlyName = "Light";
                else if (newThemeSlug === 'indigo-magic-theme') themeUserFriendlyName = "Indigo Magic";
                else if (newThemeSlug === 'crimson-peak-theme') themeUserFriendlyName = "Crimson Peak";
                else themeUserFriendlyName = "Default Dark"; // For default-dark or any other case
                
                if (newThemeSlug === 'light-mode') {
                    themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun');
                } else {
                    themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon');
                }

                const nextThemeIndex = (currentThemeIndex + 1) % themes.length;
                let nextThemeUserFriendlyName = themes[nextThemeIndex].replace('-theme','').replace('-mode','').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                if (themes[nextThemeIndex] === 'default-dark') nextThemeUserFriendlyName = "Default Dark";


                themeToggleButton.title = `Switch to ${nextThemeUserFriendlyName} Theme`;
                showTemporaryMessage(`Switched to ${themeUserFriendlyName} Theme`, 1500);
                
                updateUserAvatar();
                applyDockTransparency(); 
                applyWindowTransparency(); 
                // Update settings app theme selector if open
                const settingsThemeSelector = document.querySelector('#settings-theme-selector');
                if (settingsThemeSelector) settingsThemeSelector.value = currentThemeIndex;
            });
            
            showDesktopButton.addEventListener('click', () => {
                let allWereMinimizedOrNoWindows = true;
                let windowsToToggle = [];
                Object.values(openWindows).forEach(winData => {
                    if (winData.desktop === currentVirtualDesktop && !winData.minimized) {
                        windowsToToggle.push(winData.element.id);
                        allWereMinimizedOrNoWindows = false;
                    }
                });

                if (!allWereMinimizedOrNoWindows) { 
                    windowsToToggle.forEach(id => toggleMinimizeWindow(id));
                    showTemporaryMessage("Showing desktop...", 1500);
                } else { 
                    let restoredAny = false;
                     Object.values(openWindows).forEach(winData => {
                        if (winData.desktop === currentVirtualDesktop && winData.minimized) {
                            toggleMinimizeWindow(winData.element.id);
                            restoredAny = true;
                        }
                    });
                    showTemporaryMessage(restoredAny ? "Restoring windows..." : "Desktop is clear.", 1500);
                }
                focusDesktop();
            });
        }

        function initializeDesktop() {
            updateVirtualDesktopSwitcherUI(); 
            initializeDock(); 
            renderCalendar(); 
            updateSidebarWeather(); 
            // Removed makeFolderDraggable for appLauncherFolder as it's no longer on the desktop
            makeFolderDraggable(myFilesFolder, 'file-explorer');
            
            const initialWallpaper = wallpapers[currentWallpaperIdx];
            if (wallpaperContainer && initialWallpaper) {
                if (initialWallpaper.url) {
                    wallpaperContainer.style.backgroundImage = `url('${initialWallpaper.url}')`;
                } else {
                    wallpaperContainer.style.backgroundImage = '';
                    wallpaperContainer.className = `wallpaper ${initialWallpaper.class || ''}`;
                }
            }
            
            initializeDesktopEventListeners(); 

            createWindow('file-explorer', {}, 1); 
            setTimeout(() => createWindow('web-browser', {url: "https://www.google.com"}, 1), 250); 
            setTimeout(() => createWindow('notepad', {}, 1), 500); 
            
            focusDesktop(); 
            const wifiButton = document.querySelector('#right-sidebar .sidebar-icon i.fa-wifi');
            if (wifiButton && wifiButton.parentElement) {
                 const statusEl = wifiButton.parentElement.querySelector('span:last-child');
                 if (statusEl) {
                    statusEl.textContent = 'On';
                    statusEl.classList.add('text-[var(--secondary-accent)]');
                    statusEl.classList.remove('text-[var(--error-color)]', 'hidden');
                 }
            }
            updateWindowVisibility();
            updateSystemUptime(); 
            setInterval(updateSystemUptime, 60000); 
            setInterval(updateClock, 1000); updateClock();
            setInterval(updateSystemMeters, 3000); updateSystemMeters();
            applyDockTransparency(); // Apply default dock transparency
            applyWindowTransparency(); // Apply default window transparency
        }


        window.onload = () => {
            assignGlobalElements(); 

            if(topPanel) topPanel.style.display = 'none';
            if(desktopArea) desktopArea.style.display = 'none';
            if(dock) dock.style.display = 'none';
            if(rightSidebar) rightSidebar.style.display = 'none';
            
            // Set initial theme to Indigo Magic
            currentThemeIndex = themes.indexOf('indigo-magic-theme');
            if (currentThemeIndex === -1) currentThemeIndex = 0; // Fallback if not found
            const initialThemeSlug = themes[currentThemeIndex];
            
            document.body.classList.remove('light-mode', 'crimson-peak-theme'); // Clear others
            if (initialThemeSlug !== 'default-dark') {
                document.body.classList.add(initialThemeSlug);
            }

            const themeIcon = themeToggleButton.querySelector('i');
            if (initialThemeSlug === 'light-mode') {
                themeIcon.classList.remove('fa-moon'); themeIcon.classList.add('fa-sun');
            } else {
                themeIcon.classList.remove('fa-sun'); themeIcon.classList.add('fa-moon');
            }
            const nextThemeIndex = (currentThemeIndex + 1) % themes.length;
            let nextThemeUserFriendlyName = themes[nextThemeIndex].replace('-theme','').replace('-mode','').split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
            if (themes[nextThemeIndex] === 'default-dark') nextThemeUserFriendlyName = "Default Dark";
            themeToggleButton.title = `Switch to ${nextThemeUserFriendlyName} Theme`;
            
            updateUserAvatar(); 
            applyDockTransparency(); 
            applyWindowTransparency(); 

            if (osVersionInfoEl) osVersionInfoEl.textContent = OS_VERSION;
            if (systemUptimeEl) systemUptimeEl.textContent = "0d 0h 0m"; 

            if (loginButton) loginButton.addEventListener('click', handleLogin);
            if (usernameInput) {
                usernameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') handleLogin();
                });
                usernameInput.focus();
            }
        };
        
    </script>
</body>
</html>
